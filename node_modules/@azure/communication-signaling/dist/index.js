'use strict';

var uuid = require('uuid');
var coreUtil = require('@azure/core-util');
var coreClient = require('@azure/core-client');
var coreRestPipeline = require('@azure/core-rest-pipeline');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var uuid__default = /*#__PURE__*/_interopDefaultLegacy(uuid);
var coreUtil__default = /*#__PURE__*/_interopDefaultLegacy(coreUtil);
var coreClient__default = /*#__PURE__*/_interopDefaultLegacy(coreClient);
var coreRestPipeline__default = /*#__PURE__*/_interopDefaultLegacy(coreRestPipeline);

var commonjsGlobal = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : typeof global !== 'undefined' ? global : typeof self !== 'undefined' ? self : {};

function unwrapExports (x) {
	return x && x.__esModule && Object.prototype.hasOwnProperty.call(x, 'default') ? x['default'] : x;
}

function createCommonjsModule(fn, module) {
	return module = { exports: {} }, fn(module, module.exports), module.exports;
}

var tsregistrar = createCommonjsModule(function (module, exports) {
!function(t,e){module.exports=e();}(commonjsGlobal,function(){return function(t){function e(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var r={};return e.m=t,e.c=r,e.i=function(t){return t},e.d=function(t,r,n){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:n});},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=1)}([function(t,e,r){function n(t,e){var r,n=new Promise(function(e,n){fetch(t).then(function(t){void 0!==r&&clearTimeout(r),e(t);}).catch(function(t){void 0!==r&&clearTimeout(r),n(t);});});if(0!==e){var o=new Promise(function(n,o){r=setTimeout(o,e,new Error("Fetch for '".concat(t.url,"' timed out")));});return Promise.race([n,o])}return n}function o(t){try{return JSON.stringify(t)}catch(e){return "Unable to serialize object of type ".concat(typeof t)}}Object.defineProperty(e,"__esModule",{value:!0}),e.Timespan=e.toJson=e.fetchWithTimeout=void 0,e.fetchWithTimeout=n,e.toJson=o;var i=function(){function t(){this.start=Date.now();}return Object.defineProperty(t.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this.start},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this.start=Date.now();},t}();e.Timespan=i;},function(t,e,r){function n(t,e,r){return new h(t,e,r)}var o=this&&this.__extends||function(){var t=function(e,r){return (t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e;}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);})(e,r)};return function(e,r){function n(){this.constructor=e;}if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n);}}(),i=this&&this.__assign||function(){return i=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++){e=arguments[r];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);}return t},i.apply(this,arguments)},s=this&&this.__awaiter||function(t,e,r,n){function o(t){return t instanceof r?t:new r(function(e){e(t);})}return new(r||(r=Promise))(function(r,i){function s(t){try{c(n.next(t));}catch(t){i(t);}}function a(t){try{c(n.throw(t));}catch(t){i(t);}}function c(t){t.done?r(t.value):o(t.value).then(s,a);}c((n=n.apply(t,e||[])).next());})},a=this&&this.__generator||function(t,e){function r(t){return function(e){return n([t,e])}}function n(r){if(o)throw new TypeError("Generator is already executing.");for(;a&&(a=0,r[0]&&(c=0)),c;)try{if(o=1,i&&(s=2&r[0]?i.return:r[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,r[1])).done)return s;switch(i=0,s&&(r=[2&r[0],s.value]),r[0]){case 0:case 1:s=r;break;case 4:return c.label++,{value:r[1],done:!1};case 5:c.label++,i=r[1],r=[0];continue;case 7:r=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===r[0]||2===r[0])){c=0;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){c.label=r[1];break}if(6===r[0]&&c.label<s[1]){c.label=s[1],s=r;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(r);break}s[2]&&c.ops.pop(),c.trys.pop();continue}r=e.call(t,c);}catch(t){r=[6,t],i=0;}finally{o=s=0;}if(5&r[0])throw r[1];return {value:r[0]?r[1]:void 0,done:!0}}var o,i,s,a,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a};Object.defineProperty(e,"__esModule",{value:!0}),e.createRegistrarClient=e.RegistrarClient=void 0;var c=r(0),u=["skype","aad","cae"],l=function(t){function e(e){var r=t.call(this,e)||this;return r.name="CancelationError",r}return o(e,t),e}(Error),f=function(){function t(e,r,n){this.logger=e,this.maxBackoffInMs=r,this.initialDelay=n,this.backoffCount=0,this.id=++t.idCounter;}return t.prototype.delay=function(t){var e=this;if(void 0!==this.timerHandle)throw new Error("Retry sequence logical failure");if(-1===this.backoffCount)return new Promise(function(t,e){e(new l("Cancelled"));});var r=this.calculateNextBackoffMs();return this.backoffCount++,this.logger.info("[RegistrarClient] Backing off ".concat(t," for ").concat(r," milliseconds with ID ").concat(this.id)),new Promise(function(n,o){e.cancelFunc=o,e.timerHandle=setTimeout(function(){e.logger.info("[RegistrarClient] Back off for ".concat(t," with ID ").concat(e.id," complete")),e.timerHandle=void 0,n();},r);})},t.prototype.cancel=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off"),clearTimeout(this.timerHandle),void 0!==this.cancelFunc&&this.cancelFunc(new l("Cancelled"))),this.backoffCount=-1;},t.prototype.calculateNextBackoffMs=function(){var t=1+.4*(Math.random()-.5),e=this.initialDelay*Math.pow(2,this.backoffCount)*t;return e=Math.round(e),Math.min(this.maxBackoffInMs,e)},t.idCounter=0,t}(),h=function(){function t(t,e,r){var n;this.logger=t,this.tokenProvider=e,this.options=r,this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN=15,this.DEFAULT_MAX_BACKOFF_TIME_IN_MS=3e5,this.backoffs={},this.maxBackOffTime=this.options.maxRetryDelayMs>0?this.options.maxRetryDelayMs:this.DEFAULT_MAX_BACKOFF_TIME_IN_MS,this.maxRetriesForGetToken=void 0===r.maxRetriesForGetToken||null===r.maxRetriesForGetToken?this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN:r.maxRetriesForGetToken,this.proxyUrlRewrite=null!==(n=r.proxyUrlRewrite)&&void 0!==n?n:function(t){return t};}return t.prototype.setTelemetryLogger=function(t){this.eventLogger=t;},t.prototype.register=function(t,e){return s(this,void 0,void 0,function(){return a(this,function(r){switch(r.label){case 0:return [4,this.performRegistration(t,e,"pr_set_registration")];case 1:return r.sent(),this.cachedRegistrationParams=[t,e],[2]}})})},t.prototype.unregister=function(){return s(this,void 0,void 0,function(){var t;return a(this,function(e){switch(e.label){case 0:return this.logger.info("[RegistrarClient] sending unregister request"),t=new Request(this.proxyUrlRewrite("".concat(this.options.registrarUrl,"/").concat(this.options.registrationId)),{method:"DELETE",mode:"cors",headers:new Headers(i(i({},this.options.extraRegistrationHeaders),{accept:"application/json, text/javascript"}))}),[4,this.callRegistrar(t,"pr_delete_registration")];case 1:return e.sent(),[2]}})})},t.prototype.cancelPendingRequests=function(){var t=this;Object.keys(this.backoffs).forEach(function(e){t.backoffs[e].cancel();}),this.backoffs={};},t.prototype.resendRegistration=function(){return s(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:if(!this.cachedRegistrationParams)throw new Error("Re-registration failed because there is no registration parameters cached");return [4,this.performRegistration(this.cachedRegistrationParams[0],this.cachedRegistrationParams[1],"pr_resend_registration")];case 1:return t.sent(),[2]}})})},t.prototype.performRegistration=function(t,e,r){return s(this,void 0,void 0,function(){var n,o;return a(this,function(s){switch(s.label){case 0:return this.logger.info("[RegistrarClient] Sending register request"),n={clientDescription:t,registrationId:this.options.registrationId,nodeId:"",transports:e},o=new Request(this.proxyUrlRewrite(this.options.registrarUrl),{method:"POST",mode:"cors",headers:new Headers(i(i({},this.options.extraRegistrationHeaders),{"content-type":"application/json",accept:"application/json, text/javascript"})),body:(0, c.toJson)(n)}),[4,this.callRegistrar(o,r)];case 1:return s.sent(),[2]}})})},t.prototype.startBackoff=function(){var t=new f(this.logger,this.maxBackOffTime,this.options.initialRetryDelayMs);return this.backoffs[t.id]=t,t},t.prototype.stopBackoff=function(t){t.cancel(),delete this.backoffs[t.id];},t.prototype.getToken=function(t){return s(this,void 0,void 0,function(){var e,r,n,o,i,s,c;return a(this,function(a){switch(a.label){case 0:e=this.startBackoff(),r=0,a.label=1;case 1:return a.trys.push([1,3,,8]),this.logger.info("[RegistrarClient] Asking for a new token"),[4,this.tokenProvider({needFresh:!0,supportedTokenTypes:u,wwwAuthenticateHeader:t,purpose:"registrar"})];case 2:return n=a.sent(),this.stopBackoff(e),[2,n];case 3:o=a.sent(),a.label=4;case 4:return a.trys.push([4,6,,7]),(r++,i=JSON.stringify(o),r>this.maxRetriesForGetToken)?(s="[RegistrarClient] getToken retry limit hit. Will not retry now. Error: ".concat(i),this.logger.error(s),this.stopBackoff(e),[2,Promise.reject(s)]):(this.logger.warn("[RegistrarClient] Retrying for a new token. Retry Count: ".concat(r," Error: ").concat(i)),[4,e.delay("Fetching a new token")]);case 5:return a.sent(),[3,8];case 6:throw c=a.sent(),this.stopBackoff(e),c;case 7:return [3,8];case 8:return [3,1];case 9:return [2]}})})},t.prototype.callRegistrar=function(t,e){var r,n,o;return s(this,void 0,void 0,function(){var i,s,l,f,h,p,d,g,y,v,w,k,m,b,R,_;return a(this,function(a){switch(a.label){case 0:return i=this.startBackoff(),[4,this.tokenProvider({needFresh:!1,supportedTokenTypes:u,wwwAuthenticateHeader:void 0,purpose:"registrar"})];case 1:s=a.sent(),this.setTokenHeader(t,s),l=new c.Timespan,f=0,a.label=2;case 2:h=void 0,a.label=3;case 3:return a.trys.push([3,10,15,16]),p=t.clone(),[4,(0, c.fetchWithTimeout)(p,this.options.requestTimeoutMs)];case 4:return h=a.sent(),401!==h.status?[3,8]:++f>this.maxRetriesForGetToken?(d="[RegistrarClient] getSkypeToken retry limit hit. Will not retry now. Request '".concat(t.url,"' failed with ").concat(h.status," ").concat(h.statusText),this.logger.error(d),this.stopBackoff(i),[2,Promise.reject(d)]):(this.logger.warn("[RegistrarClient] Retry Count ".concat(f,". Request '").concat(t.url,"' failed with ").concat(h.status," ").concat(h.statusText)),g=null!==(n=null===(r=h.headers)||void 0===r?void 0:r.get("www-authenticate"))&&void 0!==n?n:void 0,y=this.setTokenHeader,v=[t],[4,this.getToken(g)]);case 5:return y.apply(this,v.concat([a.sent()])),f>1?[4,i.delay("Registrar call retry after 401")]:[3,7];case 6:a.sent(),a.label=7;case 7:return [3,22];case 8:if(h.status>=500&&h.status<600)throw new Error("Fetch for '".concat(t.url,"' failed with ").concat(h.status," ").concat(h.statusText));a.label=9;case 9:return [3,16];case 10:w=a.sent(),this.logger.error("[RegistrarClient] Request failed with ".concat(w)),a.label=11;case 11:return a.trys.push([11,13,,14]),[4,i.delay("Registrar call retry")];case 12:return a.sent(),[3,22];case 13:throw k=a.sent(),this.logger.error("[RegistrarClient] Request cancelled"),this.stopBackoff(i),k;case 14:return [3,16];case 15:return this.sendTelemetryEvent(e,t,h,l),[7];case 16:return this.stopBackoff(i),h.ok?[2,h]:[3,17];case 17:m=void 0,a.label=18;case 18:return a.trys.push([18,20,,21]),R=(b=JSON).stringify,[4,h.json()];case 19:return m=R.apply(b,[a.sent()]),[3,21];case 20:return a.sent(),m="no details",[3,21];case 21:throw _="Fetch for '".concat(t.url,"' failed with ").concat(h.status," ").concat(h.statusText," (").concat(m,", MS-CV: ").concat(null===(o=h.headers)||void 0===o?void 0:o.get("MS-CV"),")"),this.logger.error("[RegistrarClient] ".concat(_)),new Error(_);case 22:return [3,2];case 23:return [2]}})})},t.prototype.setTokenHeader=function(t,e){switch(t.headers.delete("X-Skypetoken"),t.headers.delete("Authorization"),t.headers.delete("X-MS-Migration"),e.tokenType.toLowerCase()){case"skype":t.headers.set("X-Skypetoken",e.token);break;case"aad":case"cae":t.headers.set("Authorization","Bearer ".concat(e.token));break;default:throw new Error("unsupported token type: ".concat(e.tokenType))}!1===this.options.usingLegacyTokenApi&&t.headers.set("X-MS-Migration","True");},t.prototype.sendTelemetryEvent=function(t,e,r,n){if(void 0!==this.eventLogger){var o={name:t,properties:{url:{value:e.url},result_code:{value:void 0!==r?r.status:0},begin_timestamp:{value:n.startTime},elapsed:{value:n.duration}}};this.eventLogger.logEvent(o);}},t}();e.RegistrarClient=h,e.createRegistrarClient=n;}])});

});

unwrapExports(tsregistrar);

var tstrouter = createCommonjsModule(function (module, exports) {
!function(t,e){module.exports=e(tsregistrar);}(commonjsGlobal,function(t){return function(t){function e(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:o});},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=20)}([function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.Logger=void 0;var o=function(){function t(t,e){this.name=t,this.logger=e;}return t.prototype.debug=function(t){this.logger.debug("[".concat(this.name,"] ").concat(t));},t.prototype.info=function(t){this.logger.info("[".concat(this.name,"] ").concat(t));},t.prototype.warn=function(t){this.logger.warn("[".concat(this.name,"] ").concat(t));},t.prototype.error=function(t){this.logger.error("[".concat(this.name,"] ").concat(t));},t}();e.Logger=o;},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.USER_AUTHENTICATE_EVENT_NAME=e.SUPPORTED_TOKEN_TYPES=e.FAILED_MESSAGE_ACK=e.UNHANDLED_MESSAGE_ACK=e.HANDLED_MESSAGE_ACK=e.CLIENT_VERSION=e.constants=void 0,e.constants={TROUTER_INIT:"trouterinit",TROUTER_READY_EVENT:"trouterReadyEvent",TROUTER_READY_TIMEOUT:"trouterReadyTimeout",TROUTER_TOKEN_REQUEST:"trouterTokenRequest",TROUTER_TOKEN_GET_SUCCEEDED:"trouterTokenGetSucceeded",TROUTER_TOKEN_GET_FAILED:"trouterTokenGetFailed",TROUTER_RECONNECTING:"trouterReconnecting",RENEWAL:"renewal",NEW_CONNECTION:"newConnection",ENDPOINT_REGISTRATION_FAILED:"endpointRegistrationFailed"},e.CLIENT_VERSION="2024.14.01.55",e.HANDLED_MESSAGE_ACK=200,e.UNHANDLED_MESSAGE_ACK=404,e.FAILED_MESSAGE_ACK=500,e.SUPPORTED_TOKEN_TYPES=["skype","aad","cae"],e.USER_AUTHENTICATE_EVENT_NAME="user.authenticate";},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.TrouterState=e.UserActivityState=void 0;var o;!function(t){t[t.Unknown=0]="Unknown",t[t.Active=1]="Active",t[t.Inactive=2]="Inactive";}(o||(e.UserActivityState=o={}));var i;!function(t){t[t.Unknown=0]="Unknown",t[t.Connected=2]="Connected",t[t.Disconnected=3]="Disconnected",t[t.Switching=9]="Switching";}(i||(e.TrouterState=i={}));},function(t,e,n){function o(t){try{return JSON.stringify(t)}catch(e){return "Unable to serialize object of type ".concat(typeof t)}}function i(t){var e=Math.round((new Date).getTime()/1e3);return void 0!==t&&t>e?t-e:0}function r(t){return Math.round((new Date).getTime()/1e3)+t}function s(t,e){return c(this,void 0,void 0,function(){var n,o,i;return a(this,function(r){return o=new Promise(function(e,o){fetch(t).then(function(t){clearTimeout(n),e(t);}).catch(function(t){clearTimeout(n),o(t);});}),0!==e?(i=new Promise(function(o,i){var r=new URL(t.url),s=new Error("".concat(t.method," ").concat(r.origin).concat(r.pathname," timed out"));n=setTimeout(i,e,s);}),[2,Promise.race([o,i])]):[2,o]})})}var c=this&&this.__awaiter||function(t,e,n,o){function i(t){return t instanceof n?t:new n(function(e){e(t);})}return new(n||(n=Promise))(function(n,r){function s(t){try{a(o.next(t));}catch(t){r(t);}}function c(t){try{a(o.throw(t));}catch(t){r(t);}}function a(t){t.done?n(t.value):i(t.value).then(s,c);}a((o=o.apply(t,e||[])).next());})},a=this&&this.__generator||function(t,e){function n(t){return function(e){return o([t,e])}}function o(n){if(i)throw new TypeError("Generator is already executing.");for(;c&&(c=0,n[0]&&(a=0)),a;)try{if(i=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(s=a.trys,!(s=s.length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(6===n[0]&&a.label<s[1]){a.label=s[1],s=n;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(n);break}s[2]&&a.ops.pop(),a.trys.pop();continue}n=e.call(t,a);}catch(t){n=[6,t],r=0;}finally{i=s=0;}if(5&n[0])throw n[1];return {value:n[0]?n[1]:void 0,done:!0}}var i,r,s,c,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return c={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c};Object.defineProperty(e,"__esModule",{value:!0}),e.Timespan=e.CorrelationVector=e.fetchWithTimeout=e.calculateExpireTsInSec=e.calculateTtlInSec=e.toJson=void 0,e.toJson=o,e.calculateTtlInSec=i,e.calculateExpireTsInSec=r,e.fetchWithTimeout=s;var u=function(){function t(t){this.base=void 0!==t?t:this.createCorrelationVectorBase(),this.extension=0;}return t.extend=function(e){return new t(e)},t.prototype.increase=function(){this.extension++;},t.prototype.value=function(){return "".concat(this.base,".").concat(this.extension)},t.prototype.createCorrelationVectorBase=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0987654321/+",e="AQgw",n="",o=0;o<21;o++)n+=t.charAt(Math.floor(Math.random()*t.length));return n+=e.charAt(Math.floor(Math.random()*e.length))},t}();e.CorrelationVector=u;var h=function(){function t(){this.start=Date.now();}return Object.defineProperty(t.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this.start},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this.start=Date.now();},t}();e.Timespan=h;},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.TrouterManagerState=e.UserActivityEventReason=e.ServerState=void 0;var o=n(3),i=function(){function t(t,e,n,o,i,r,s){this.connectionId=t,this.connectedClientId=e,this.domId=n,this.unsecureUrl=o,this.url=i,this.c2cUrlBase=r,this.expirationTsSec=s;}return t.prototype.getRemainingTtlInSec=function(){return (0, o.calculateTtlInSec)(this.expirationTsSec)},t}();e.ServerState=i;var r;!function(t){t[t.Unknown=0]="Unknown",t[t.Modified=1]="Modified",t[t.Snapshot=2]="Snapshot",t[t.Connected=3]="Connected";}(r||(e.UserActivityEventReason=r={}));var s;!function(t){t[t.Unknown=0]="Unknown",t[t.Connected=2]="Connected",t[t.Disconnected=3]="Disconnected",t[t.Switching=9]="Switching",t[t.TerminalError=10]="TerminalError";}(s||(e.TrouterManagerState=s={}));},function(t,e,n){function o(t,e){return "skype"===t&&"1"!==i(null===e||void 0===e?void 0:e.scae)?"v4a":"v4c"}function i(t){return "string"==typeof t?t:"number"==typeof t?t.toString():void 0}function r(t,e){return "v4c-websocket-failure"===(null===e||void 0===e?void 0:e.kind)?"v4a":t}function s(t){return Object.prototype.hasOwnProperty.call(t,"connectparams")}function c(t,e){return "v4a"===e?t.replace(/\/v4\/c\b/,"/v4/a").replace("wss://","https://").replace("ws://","http://"):t.replace(/\/v4\/a\b/,"/v4/c").replace("https://","wss://").replace("http://","ws://")}function a(t){if(void 0!==t)return d(d({},t),{reconnectUrl:void 0,serviceUrl:void 0})}function u(t){return "string"==typeof t?parseInt(t,10):t}function h(t){if("redirect"===(null===t||void 0===t?void 0:t.kind)&&void 0!==t.host){var e=t.host;return e.endsWith("/")&&(e=e.substring(0,e.length-1)),e.endsWith("/v4/c")||e.endsWith("/v4/a")||(e+="/v4/c"),e}}var d=this&&this.__assign||function(){return d=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++){e=arguments[n];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);}return t},d.apply(this,arguments)};Object.defineProperty(e,"__esModule",{value:!0}),e.redirectUrlIfPresent=e.ensureNumber=e.reconnectParamsWithoutUrls=e.adaptUrl=e.isV4ConnectEvent=e.usedProtocolAfterFallback=e.usedProtocol=void 0,e.usedProtocol=o,e.usedProtocolAfterFallback=r,e.isV4ConnectEvent=s,e.adaptUrl=c,e.reconnectParamsWithoutUrls=a,e.ensureNumber=u,e.redirectUrlIfPresent=h;},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.TrouterFsm=e.State=void 0;var o,i=n(4),r=n(0),s=n(5);!function(t){t[t.Initial=0]="Initial",t[t.RetrievingToken=1]="RetrievingToken",t[t.Allocating=2]="Allocating",t[t.Handshaking=3]="Handshaking",t[t.Connecting=4]="Connecting",t[t.AnonymousConnecting=5]="AnonymousConnecting",t[t.WebsocketAuthenticating=6]="WebsocketAuthenticating",t[t.Connected=7]="Connected",t[t.Unregistering=8]="Unregistering",t[t.TerminalError=9]="TerminalError";}(o||(e.State=o={}));var c;!function(t){t[t.Initial=0]="Initial",t[t.Registering=1]="Registering",t[t.RegisteringButResendPending=2]="RegisteringButResendPending",t[t.Retrying=3]="Retrying",t[t.Registered=4]="Registered",t[t.RegistrationDisabled=5]="RegistrationDisabled";}(c||(c={}));var a=function(){function t(t,e,n,i){this.worker=e,this.incallModeEnabled=n,this.protocolSelector=i,this.state=o.Initial,this.autoReconnect=!0,this.logger=new r.Logger("ConnectionFsm",t),this.registrationState=c.Initial;}return t.prototype.getState=function(){return this.state},t.prototype.isActive=function(){return this.state===o.Allocating||this.state===o.Connected||this.state===o.Handshaking||this.state===o.Connecting||this.state===o.RetrievingToken||this.state===o.AnonymousConnecting||this.state===o.WebsocketAuthenticating},t.prototype.isConnecting=function(){return this.state===o.Allocating||this.state===o.Handshaking||this.state===o.Connecting||this.state===o.AnonymousConnecting},t.prototype.start=function(){return this.state===o.Initial?(this.setState(o.RetrievingToken),this.worker.getToken(!0,!1,void 0),!0):(this.showIgnored("start"),!1)},t.prototype.stop=function(t,e){t&&(this.registrationState=c.Initial),this.worker.isIncallMode()&&this.worker.exitIncallMode(),this.worker.resetTokenBackoff(),this.worker.cancelPendingRegistrationRequests(),this.worker.stopConnectionTimer(),this.worker.stopPingTimer(),this.worker.clearSentEventTimers(),this.worker.stopRegistrationTimer(),this.worker.stopSocketIo(),this.state===o.Connected&&this.worker.sendDisconnectTelemetryEvent("connection stopped"),this.registrationState!==c.Registered&&this.registrationState!==c.Registering&&this.registrationState!==c.RegisteringButResendPending||this.state===o.Unregistering?e?(this.setState(o.TerminalError),this.worker.dispatchTerminalError()):(this.setState(o.Initial),this.worker.dispatchDisconnected()):(this.registrationState=c.Initial,this.setState(o.Unregistering),this.worker.sendUnregisterRequest());},t.prototype.onTokenReceived=function(t,e,n){this.state===o.RetrievingToken?"v4c"===(0, s.usedProtocolAfterFallback)(this.protocolSelector(t.tokenType,n),e)?(this.setState(o.AnonymousConnecting),this.worker.startConnectionTimer(),this.worker.connectV4c(t,e)):(this.setState(o.Allocating),this.worker.startConnectionTimer(),this.worker.sendAllocateRequest(t)):this.showIgnored("onTokenReceived");},t.prototype.checkConnection=function(t){t&&this.onPingInterval();},t.prototype.onAllocationSucceed=function(t){return this.state===o.Allocating&&this.registrationState===c.Registered&&this.worker.dispatchUnregistered(),this.state===o.Allocating?(this.setState(o.Handshaking),this.registrationState=c.Initial,this.worker.startSocketIo(t),!0):(this.showIgnored("onAllocationSucceed"),!1)},t.prototype.onAllocationFailed=function(t,e){this.state===o.Allocating?this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!t,claimsChallenge:e}):this.showIgnored("onAllocationFailed");},t.prototype.onV4cException=function(){this.state!==o.AnonymousConnecting&&this.state!==o.WebsocketAuthenticating||(this.logger.error("v4c exception, falling back to longpoll"),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"v4c-websocket-failure"}}));},t.prototype.onConnectingTimeout=function(){this.state===o.Allocating||this.state===o.Connecting||this.state===o.Handshaking||this.state===o.AnonymousConnecting||this.state===o.WebsocketAuthenticating?this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0}):this.showIgnored("onConnectingTimeout");},t.prototype.onConnecting=function(){this.state===o.Handshaking?this.setState(o.Connecting):this.showIgnored("onConnecting");},t.prototype.onSocketConnect=function(t){this.state===o.AnonymousConnecting?(this.setState(o.WebsocketAuthenticating),this.worker.sendV4cAuthenticationEvent(t)):this.showIgnored("onSocketConnect");},t.prototype.onConnectingFailed=function(){this.state===o.Connecting?this.onConnectingTimeout():this.state===o.Handshaking?(this.logger.error("Unexpected error in Socket.io - no valid transports"),this.onConnectingTimeout()):this.state===o.AnonymousConnecting||this.state===o.WebsocketAuthenticating?(this.logger.info("/v4/c falling back to longpoll"),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"v4c-websocket-failure"}})):this.showIgnored("onConnectingFailed");},t.prototype.onSocketDisconnect=function(t){this.state===o.Handshaking||this.state===o.Connected||this.state===o.WebsocketAuthenticating?(this.state===o.Connected&&this.worker.sendDisconnectTelemetryEvent(null===t||void 0===t?void 0:t.toTelemetryString()),this.state===o.WebsocketAuthenticating&&this.worker.countDisconnectBeforeConnectionEstablishment(),"skypetoken-deprecated"===(null===t||void 0===t?void 0:t.reason)?(this.logger.error("Skypetoken deprecated response, not retrying any further"),this.onTerminalError()):this.cleanUpAndInitiateReconnect({backoff:this.state!==o.Connected&&"dup"!==(null===t||void 0===t?void 0:t.reason),allowCachedToken:"unauthorized"!==(null===t||void 0===t?void 0:t.reason),claimsChallenge:null===t||void 0===t?void 0:t.claims})):this.showIgnored("onSocketDisconnect");},t.prototype.onTrouterConnected=function(){this.state===o.Connecting||this.state===o.WebsocketAuthenticating?(this.setState(o.Connected),this.worker.resetTokenBackoff(),this.worker.stopConnectionTimer(),this.worker.sendUserActivityState(i.UserActivityEventReason.Connected,!0),this.worker.startPingTimer(),this.worker.dispatchConnected(),this.worker.shouldSkipRegistration()?(this.registrationState=c.RegistrationDisabled,this.worker.dispatchRegistered()):(this.registrationState=c.Registering,this.worker.sendRegisterRequest())):this.showIgnored("onTrouterConnected");},t.prototype.onReconnectRequired=function(t,e,n){this.state===o.AnonymousConnecting||this.state===o.WebsocketAuthenticating?void 0===n||"host"!==n.target||void 0===n.url||""===n.url?(this.logger.error("unexpected reconnect arguments: ".concat(null===n||void 0===n?void 0:n.target," ").concat(null===n||void 0===n?void 0:n.url,", reconnecting without cache")),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"redirect-no-host"}})):this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"redirect",host:n.url}}):this.worker.dispatchReconnectIsRequired(t,e);},t.prototype.disableAutoReconnect=function(){this.autoReconnect=!1;},t.prototype.onDownstreamRequest=function(t){this.state===o.Connected?(this.switchToIncallModeIfEnabled(),this.worker.dispatchDownstreamRequest(t)):this.showIgnored("onDownstreamRequest");},t.prototype.onTrouterMessageLost=function(t){this.state===o.Connected?this.worker.dispatchTrouterMessageLost(t):this.showIgnored("onTrouterMessageLost");},t.prototype.onPingInterval=function(){this.state===o.Connected?this.worker.sendPingRequest():this.showIgnored("onPingInterval");},t.prototype.onPingResponseTimeout=function(){this.onMissedResponse("onPingResponseTimeout");},t.prototype.onPingResponse=function(){this.state===o.Connected||this.showIgnored("onPingResponse");},t.prototype.onRegistrationFailed=function(){this.state===o.Connected&&this.registrationState===c.Registering?(this.worker.dispatchUnregistered(),this.registrationState=c.Retrying,this.worker.startRegistrationRetryTimer()):this.state===o.Connected&&this.registrationState===c.RegisteringButResendPending?(this.registrationState=c.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationFailed");},t.prototype.onRetryRegistration=function(){this.state===o.Connected&&this.registrationState===c.Retrying?(this.registrationState=c.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRetryRegistration");},t.prototype.onRegistrationSucceeded=function(){this.state===o.Connected&&this.registrationState===c.Registering?(this.registrationState=c.Registered,this.worker.dispatchRegistered(),this.worker.startRegistrationTimer()):this.state===o.Connected&&this.registrationState===c.RegisteringButResendPending?(this.registrationState=c.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationSucceeded");},t.prototype.onRegistrationNearExpiry=function(){this.state===o.Connected&&this.registrationState===c.Registered?(this.registrationState=c.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationNearExpiry");},t.prototype.onUnregistrationDone=function(){this.state===o.Unregistering?(this.setState(o.Initial),this.worker.dispatchUnregistered(),this.worker.dispatchDisconnected()):this.showIgnored("onUnregistrationDone");},t.prototype.onResendRegistration=function(){this.worker.dispatchUnregistered(),this.state===o.Connected&&this.registrationState===c.Registered?(this.registrationState=c.Registering,this.worker.stopRegistrationTimer(),this.worker.sendRegisterRequest()):this.state===o.Connected&&this.registrationState===c.Registering&&(this.registrationState=c.RegisteringButResendPending);},t.prototype.onIncallModeTimer=function(){this.worker.exitIncallMode(),this.state===o.Connected?(this.worker.stopPingTimer(),this.worker.startPingTimer()):this.showIgnored("onIncallModeTimer");},t.prototype.onSetNewUserActivityState=function(){this.worker.sendUserActivityState(i.UserActivityEventReason.Modified,this.state===o.Connected);},t.prototype.onActivityStateResponseTimeout=function(){this.onMissedResponse("onActivityStateResponseTimeout");},t.prototype.forceReconnect=function(t){this.state===o.Connected&&this.worker.sendDisconnectTelemetryEvent(t),this.worker.resetTokenBackoff(),this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0});},t.prototype.onTerminalError=function(){this.logger.error("Cannot proceed, reached terminal state. Switching from state '".concat(o[this.state],"' to ").concat(o[o.TerminalError])),this.stop(!0,!0),this.setState(o.TerminalError);},t.prototype.onMissedResponse=function(t){this.state===o.Connected?(this.worker.sendDisconnectTelemetryEvent(t),this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0})):this.showIgnored(t);},t.prototype.showIgnored=function(t){this.logger.debug("Ignoring event '".concat(t,"' in state '").concat(o[this.state],"'"));},t.prototype.setState=function(t){if(this.logger.info("Switching from state '".concat(o[this.state],"' to state '").concat(o[t],"'")),this.state===t)return void this.logger.error("Attempt to switch to the current state '".concat(o[t],"'"));this.state=t;},t.prototype.switchToIncallModeIfEnabled=function(){this.incallModeEnabled&&(this.worker.isIncallMode()||(this.worker.enterIncallMode(),this.worker.stopPingTimer(),this.worker.startPingTimer()),this.worker.restartIncallModeTimer());},t.prototype.cleanUpAndInitiateReconnect=function(t){if(!this.autoReconnect)return this.logger.info("Automatic reconnect is disabled, stopping this connection"),void this.stop(!0);this.worker.cancelPendingRegistrationRequests(),this.worker.stopConnectionTimer(),this.worker.stopPingTimer(),this.worker.clearSentEventTimers(),this.worker.stopRegistrationTimer(),this.worker.stopSocketIo(),this.setState(o.RetrievingToken),this.worker.dispatchReconnecting(),this.worker.getToken(t.allowCachedToken,t.backoff,t.claimsChallenge,t.fallbackReason);},t}();e.TrouterFsm=a;},function(t,e,n){function o(t,e){var n=e?void 0:{"X-MS-Migration":"True"};switch(t.tokenType.toLowerCase()){case"skype":return c({"X-Skypetoken":t.token},n);case"aad":case"cae":return c({Authorization:"Bearer ".concat(t.token)},n);default:throw new Error("unsupported token type: ".concat(t.tokenType))}}function i(t){return void 0!==t&&null!==t&&"function"==typeof t.toString?t.toString():"[".concat(typeof t,"]")}function r(t){return "object"==typeof t&&null!==t&&void 0!==t.stack?(0, l.toJson)(t.stack):'"(no error.stack)"'}function s(t){return "object"==typeof t&&null!==t&&"string"==typeof t.message?t.message:"(no error.message)"}var c=this&&this.__assign||function(){return c=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++){e=arguments[n];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);}return t},c.apply(this,arguments)},a=this&&this.__awaiter||function(t,e,n,o){function i(t){return t instanceof n?t:new n(function(e){e(t);})}return new(n||(n=Promise))(function(n,r){function s(t){try{a(o.next(t));}catch(t){r(t);}}function c(t){try{a(o.throw(t));}catch(t){r(t);}}function a(t){t.done?n(t.value):i(t.value).then(s,c);}a((o=o.apply(t,e||[])).next());})},u=this&&this.__generator||function(t,e){function n(t){return function(e){return o([t,e])}}function o(n){if(i)throw new TypeError("Generator is already executing.");for(;c&&(c=0,n[0]&&(a=0)),a;)try{if(i=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(s=a.trys,!(s=s.length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(6===n[0]&&a.label<s[1]){a.label=s[1],s=n;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(n);break}s[2]&&a.ops.pop(),a.trys.pop();continue}n=e.call(t,a);}catch(t){n=[6,t],r=0;}finally{i=s=0;}if(5&n[0])throw n[1];return {value:n[0]?n[1]:void 0,done:!0}}var i,r,s,c,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return c={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c};Object.defineProperty(e,"__esModule",{value:!0}),e.TrouterConnection=e.ReconnectReason=void 0;var h,d=n(21),l=n(3),p=n(15),g=n(1),f=n(16),v=n(17),m=n(2),y=n(4),T=n(0),S=n(5),k=n(6),w=n(12),b=function(){function t(){this.cv=g.CLIENT_VERSION,this.ua="",this.hr="",this.v="";}return t}(),R=function(){function t(){this["force new connection"]=!0,this.reconnect=!1,this.query="",this.ackTimeoutMs=5e3;}return t.prototype.rewriteUrlForProxy=function(t){return t},t}(),C="MS-CV",E=function(){function t(t,e){this.logger=e,this.cvCounter=0;var n=JSON.parse(t);this.startTS=this.safeJsonNumber(n,"startTS",0),this.url=this.safeJsonString(n,"url",""),this.shortUrl=this.safeJsonString(n,"shortUrl",""),this.body=this.safeJsonString(n,"body",""),this.headers=this.safeJsonRecord(n,"headers",{}),this.id=this.safeJsonNumber(n,"id",-1),this.method=this.safeJsonString(n,"method",""),this.replied=!1,this.timedout=!1,this.receivedCv=this.headers[C],this.updateCvHeader();}return Object.defineProperty(t.prototype,"correlationVector",{get:function(){return this.receivedCv?"".concat(this.receivedCv,".").concat(this.cvCounter):""},enumerable:!1,configurable:!0}),t.prototype.on=function(t,e){"data"===t?this.dataCallback=e:"end"===t&&("function"==typeof this.dataCallback&&this.dataCallback(this.body),e());},t.prototype.incrementCorrelationVector=function(){++this.cvCounter,this.updateCvHeader();},t.prototype.updateCvHeader=function(){var t=this.correlationVector;t&&(this.headers[C]=t);},t.prototype.safeJsonNumber=function(t,e,n){var o;if(null!==t&&void 0!==t&&Object.prototype.hasOwnProperty.call(t,e)){var i=t;if("number"==typeof i[e])return i[e];if("string"==typeof i[e])return parseFloat(i[e]);null===(o=this.logger)||void 0===o||o.warn("unexpected type of '".concat(e,"': ").concat(typeof i[e]));}return n},t.prototype.safeJsonString=function(t,e,n){var o;if(null!==t&&void 0!==t&&Object.prototype.hasOwnProperty.call(t,e)){var i=t;if("string"==typeof i[e])return i[e];null===(o=this.logger)||void 0===o||o.warn("unexpected type of '".concat(e,"': ").concat(typeof i[e]));}return n},t.prototype.safeJsonRecord=function(t,e,n){var o;if(null!==t&&void 0!==t&&Object.prototype.hasOwnProperty.call(t,e)){var i=t;if("object"==typeof i[e])return i[e];null===(o=this.logger)||void 0===o||o.warn("unexpected type of '".concat(e,"': ").concat(typeof i[e]));}return n},t}(),I=function(){function t(t,e,n){this.request=t,this.responseData=e,this.sendResponse=n;}return t.prototype.writeHead=function(t,e){this.responseData.status=t,this.responseData.headers=e;},t.prototype.write=function(t){this.responseData.body+=t;},t.prototype.end=function(t){return t&&(this.responseData.body+=t),this.sendResponse(this.request,this.responseData)},t}(),A=function(){function t(t){this.name=t,this.args={},this.timeoutTimerId=0;}return t}();!function(t){t[t.Configuration=0]="Configuration",t[t.ServerInitiated=1]="ServerInitiated";}(h||(e.ReconnectReason=h={}));var U=function(){function t(t,e,n,o,i,r,s,c){var a,u=this;this.options=e,this.manager=n,this.tokenProvider=o,this.usingLegacyTokenApi=i,this.protocolSelector=s,this.audienceSubscriptionState=c,this.WEBSOCKET_TRANSPORT_NAME="websocket",this.XHR_POLLING_TRANSPORT_NAME="xhr-polling",this.AUDIENCE_SUBSCRIPTION_RESULT_ERROR="Error",this.AUDIENCE_SUBSCRIPTION_RESULT_UNSUBSCRIBED="Unsubscribed",this.AUDIENCE_SUBSCRIPTION_RESULT_TIMEOUT="Timeout",this.AUDIENCE_SUBSCRIPTION_RESULT_BAD_REQUEST="BadRequest",this.AUDIENCE_SUBSCRIPTION_STATE_QUERY_PARAM_REGEX=/&audienceSubscriptionState=[^&]*|^audienceSubscriptionState=[^&]*&?/,this.connectionId="",this.inIncallMode=!1,this.connectionAttempt=0,this.connectedClientId="",this.isNavigatorOnline=!0,this.onNavigatorOnlineStatusUpdateBound=this.onNavigatorOnlineStatusUpdate.bind(this),this.c2cUrlBase="",this.connectingErrorsInRow=0,this.unauthorizedErrorCount=0,this.pendingSentEventTimers={},this.lastDisconnectReason="",this.UNKNOWN_TRANSPORT="unknown_transport",this.connectingErrorsThreshold=3,this.pendingAudienceSubscription=void 0,this.logger=new T.Logger("Connection",t),this.timeoutOptions=this.options.timeoutOptions,this.tokenBackoff=new v.ExponentialBackoff(this.logger,this.timeoutOptions.maxBackoffMs),this.clientID=Date.now(),"undefined"!=typeof window&&window.location&&(this.domId=window.location.hostname);var h=new b;h.cv=g.CLIENT_VERSION,h.ua="",(null===(a=this.options)||void 0===a?void 0:a.clientInfo)&&(h.ua=this.safeString(this.options.clientInfo.ua),h.v=this.safeString(this.options.clientInfo.v)),this.clientInfo=h,this.connectionTracker=new p.ConnectionTracker(t,this.clientID,this.clientInfo,function(){return u.getServerState()},this.options.endpointId,this.options.clientCorrelationID,this.options.environment),this.applyConnectionTrackerOptions(e);var l=this.options.incallModeTimeoutMs>0;if(this.fsm=new k.TrouterFsm(t,this,l,this.protocolSelector),e.registration){var f={registrarUrl:e.registration.registrarUrl,proxyUrlRewrite:e.rewriteUrlForProxy,registrationId:e.registration.registrationId,requestTimeoutMs:e.timeoutOptions.fetchTimeoutMs,initialRetryDelayMs:1e3,maxRetryDelayMs:e.timeoutOptions.maxBackoffMs,usingLegacyTokenApi:this.usingLegacyTokenApi,maxRetriesForGetToken:e.retryLimitOnTokenFetch,extraRegistrationHeaders:e.extraConnectionHeaders};this.registrarClient=(0, d.createRegistrarClient)(t,this.tokenProvider,f);}this.userActivityState=r;}return t.prototype.start=function(t){this.logger.info("Starting"),this.reconnectParams=t,"undefined"!=typeof window&&window.navigator&&window.addEventListener?(this.isNavigatorOnline=window.navigator.onLine,window.addEventListener("online",this.onNavigatorOnlineStatusUpdateBound),window.addEventListener("offline",this.onNavigatorOnlineStatusUpdateBound),this.logger.debug("Registered for browser online notifications - current state: ".concat(this.isNavigatorOnline))):this.isNavigatorOnline=!0,this.fsm.start();},t.prototype.stop=function(t){this.logger.info("Stopping"),"undefined"!=typeof window&&window.navigator&&(window.removeEventListener("online",this.onNavigatorOnlineStatusUpdateBound),window.removeEventListener("offline",this.onNavigatorOnlineStatusUpdateBound)),this.fsm.stop(t),this.connectionTracker.close();},t.prototype.configure=function(t){var e=this.options.trouterUrl!==t.trouterUrl;this.options=t,this.applyConnectionTrackerOptions(t),e&&(this.logger.info("Configuration changed. Reconnection required."),this.fsm.onReconnectRequired(!1,h.Configuration));},t.prototype.checkConnection=function(t){this.logger.info("checkConnection called with ".concat(t)),this.fsm.checkConnection(t),t&&this.connectionTracker.sendTelemetry(p.ClientEventName.CheckConnection,{disconnectDetected:t},[]);},t.prototype.disableRegistrationsAndAutoReconnect=function(){this.stopRegistrationTimer(),this.cancelPendingRegistrationRequests(),this.fsm.disableAutoReconnect();},t.prototype.getServerState=function(){return new y.ServerState(this.connectionId,this.connectedClientId,this.domId?this.domId:"",this.allocateResult?this.allocateResult.url:"",this.allocateResult?this.allocateResult.surl:"",this.c2cUrlBase,this.connectionExpireTimestampInSecs)},t.prototype.getState=function(){return this.fsm.getState()},t.prototype.getToken=function(t,e,n,o,i){var r=this;void 0===i&&(i=0),this.logger.info("Getting token ".concat(e?"with backoff":"without backoff"));var s=function(){r.connectionTracker.trackStart("token");var e={needFresh:!t,wwwAuthenticateHeader:n,supportedTokenTypes:g.SUPPORTED_TOKEN_TYPES,purpose:"trouter"};r.logger.info("Requesting token: needFresh=".concat(e.needFresh," ")+"types=[".concat(g.SUPPORTED_TOKEN_TYPES,"], ")+"wwwAuthenticateHeader is ".concat(e.wwwAuthenticateHeader?"non empty":"empty")),r.tokenProvider(e).then(function(t){r.logger.debug("".concat(t.tokenType," token is received")),r.connectionTracker.trackEnd("token"),r.fsm.onTokenReceived(t,o,r.reconnectParams);}).catch(function(e){var s=(0, l.toJson)(e.stack);if(r.logger.error("Getting token failed, will retry after timeout. Error: ".concat(s)),r.connectionTracker.trackError("token",s),!r.canRetryTokenFetchRequest(i+r.unauthorizedErrorCount)){return r.connectionTracker.trackError("token","getToken retry limit hit, reached terminal error state"),r.resetTokenBackoff(),void r.fsm.onTerminalError()}r.getToken(t,!0,n,o,i+1);});};e?this.tokenBackoff.backoff("getting token",s):(this.resetTokenBackoff(),s());},t.prototype.startConnectionTimer=function(){var t=this;this.stopConnectionTimer(),this.logger.debug("Starting connection timeout for ".concat(this.timeoutOptions.connectionTimeoutMs," ms")),this.connectionTimeoutId=setTimeout(function(){t.logger.info("Connection timeout is fired"),t.fsm.onConnectingTimeout();},this.timeoutOptions.connectionTimeoutMs);},t.prototype.stopConnectionTimer=function(){this.connectionTimeoutId&&(this.logger.debug("Stopping connection timeout"),clearTimeout(this.connectionTimeoutId),this.connectionTimeoutId=void 0);},t.prototype.startPingTimer=function(){var t=this;"websocket"===this.transportTypeName?(this.logger.debug("Starting ping timeout for ".concat(this.timeoutOptions.pingTimeoutMs," ms")),this.pingTimerId=setInterval(function(){t.logger.info("Ping interval fired"),t.fsm.onPingInterval();},this.timeoutOptions.pingTimeoutMs)):this.logger.debug("Not starting ping for transport ".concat(this.transportTypeName));},t.prototype.stopPingTimer=function(){this.pingTimerId&&(this.logger.debug("Stopping ping timeout"),this.clearPingResponseTimer(),clearInterval(this.pingTimerId),this.pingTimerId=void 0);},t.prototype.shouldSkipRegistration=function(){return void 0===this.options.registration},t.prototype.hasCustomRegistrationTtl=function(){var t,e;return void 0!==(null===(t=this.options.registration)||void 0===t?void 0:t.registrarTtlSec)&&0!==(null===(e=this.options.registration)||void 0===e?void 0:e.registrarTtlSec)},t.prototype.startRegistrationTimer=function(){var t=this;this.stopRegistrationTimer();var e=this.getRegistrationTtl(),n=e[0],o=e[1];if(n<=30||!o)return this.logger.debug("Starting registration expiration timer (TTL ".concat(n," sec)")),void(this.registrationTimerId=setTimeout(function(){t.registrationTimerId=void 0,t.logger.warn("Registration expired but the connection is still alive. Should never happen"),t.dispatchUnregistered();},1e3*n));var i=n-30;this.logger.debug("Starting registration extension timer for ".concat(i," sec")),this.registrationTimerId=setTimeout(function(){t.logger.info("Registration extension timer fired"),t.registrationTimerId=setTimeout(function(){t.registrationTimerId=void 0,t.logger.debug("Registration extension did not happen in time"),t.dispatchUnregistered();},3e4),t.fsm.onRegistrationNearExpiry();},1e3*i);},t.prototype.startRegistrationRetryTimer=function(){var t=this;this.stopRegistrationTimer();this.registrationTimerId=setTimeout(function(){t.registrationTimerId=void 0,t.fsm.onRetryRegistration();},123e3);},t.prototype.stopRegistrationTimer=function(){this.registrationTimerId&&(this.logger.debug("Stopping registration timeout"),clearTimeout(this.registrationTimerId),this.registrationTimerId=void 0);},t.prototype.resendRegistration=function(){if(!this.registrarClient)throw new Error("Trouter Client not configured to handle registrations");return this.fsm.onResendRegistration(),Promise.resolve()},t.prototype.buildSocketIoUrlParams=function(t,e){if(!this.allocateResult)throw new Error("Allocate result is undefined in buildSocketIoUrlParams()");for(var n={},o=this.allocateResult.connectparams,i=0,r=Object.keys(o);i<r.length;i++){var s=r[i];if(void 0!==o[s]){var c=o[s];"string"==typeof c||"number"==typeof c?n[s]=c:this.logger.error("signatureData[".concat(s,"] has unsupported type ").concat(typeof c));}}return n.v="v4",n.tc=encodeURI((0, l.toJson)(this.clientInfo)),n.timeout=this.timeoutOptions.pingTimeoutMs/1e3,n.auth="true",this.options.endpointId&&(n.epid=this.options.endpointId),t&&(n.userActivity=encodeURI((0, l.toJson)(t))),e&&(n.audienceSubscriptionState=encodeURIComponent((0, l.toJson)(e))),this.appendConnectedClientIds(this.buildQuery(n),!0)},t.prototype.startSocketIo=function(t){var e,n;if(this.logger.debug("Starting socket io"),this.connectionTracker.trackStart("connectSocket"),!this.allocateResult)throw new Error("Allocate result is undefined in startSocketIo()");var i=this.options.ioOptions?c({},this.options.ioOptions):new R,r=this.userActivityState.state!==m.UserActivityState.Unknown?this.userActivityState.increaseCvAndGetEventObject():void 0,s=null===(e=this.audienceSubscriptionState)||void 0===e?void 0:e.increaseCvAndGetEventObject();if(i["force new connection"]=!0,i.reconnect=!1,i.rewriteUrlForProxy=this.options.rewriteUrlForProxy,i.requestHeaders=c(c({},this.options.extraConnectionHeaders),o(t,this.usingLegacyTokenApi)),i.query=this.buildSocketIoUrlParams(r,s),this.logger.info("connecting to ".concat(this.allocateResult.socketio,"?").concat(i.query)),this.stopSocketIo(),this.socket=(null!==(n=this.options.io)&&void 0!==n?n:w).connect(this.allocateResult.socketio,i),void 0===this.socket)throw new Error("Can't create Socket.io object");this.attachSocketIoHandlers(this.socket,t,r,s);},t.prototype.stopSocketIo=function(){if(this.socket){this.logger.debug("clearing socket.io");try{for(var t=0,e=["connecting","connect","connect_failed","close_during_connecting","disconnect","reconnect","reconnect_failed","reconnecting","error","message","trouter.connected","trouter.reconnect","trouter.message_loss"];t<e.length;t++){var n=e[t];this.socket.removeAllListeners(n);}this.socket.disconnect(),this.logger.debug("cleared socket"),this.socket=void 0;}catch(t){this.logger.error("exception in disconnecting previous socket. Error: ".concat(r(t)));}}},t.prototype.dispatchConnected=function(){this.logger.info("dispatching connected"),this.manager.onConnected(this);},t.prototype.dispatchRegistered=function(){this.logger.info("dispatching registered"),this.manager.onRegistered(this);},t.prototype.dispatchUnregistered=function(){this.logger.info("dispatching unregistered"),this.manager.onUnregistered(this);},t.prototype.dispatchDownstreamRequest=function(t){var e=this;this.logger.debug("dispatching downstream request");try{var n=new I(t,new p.ResponseData(t.id),function(t,n){return e.logger.debug("sending response to downstream"),e.sendResponse(t,n)});this.manager.onDownstreamRequest(this,t,n);}catch(t){this.logger.error("exception in socket.on message. Error : ".concat(r(t)));}},t.prototype.dispatchReconnecting=function(){this.logger.info("dispatching reconnecting"),this.manager.onReconnecting(this);},t.prototype.dispatchReconnectIsRequired=function(t,e){this.logger.info("dispatching reconnect is required by server"),this.manager.onReconnectIsRequired(this,t,e);},t.prototype.dispatchDisconnected=function(){this.logger.info("dispatching disconnected"),this.manager.onDisconnected(this);},t.prototype.dispatchTerminalError=function(){this.logger.info("dispatching terminal error"),this.manager.onTerminalError(this);},t.prototype.dispatchTrouterMessageLost=function(t){this.logger.info("dispatching trouter message lost"),this.manager.onTrouterMessageLost(t);},t.prototype.countDisconnectBeforeConnectionEstablishment=function(){this.logger.warn("counting disconnect before connection was fully established as a connection failure"),++this.connectingErrorsInRow>=this.connectingErrorsThreshold&&this.resetReconnectParamsOnErrorThreshold();},t.prototype.sendProcessedDroppedIndicators=function(t){var e=this;try{this.logger.debug("emitting processed flow tags to the server");var n=new A("trouter.processed_message_loss");n.args={droppedIndicators:t},this.sendDownstreamEvent(n,function(){e.logger.info("emitted processed flow tags to the server");});}catch(t){var o=r(t);this.logger.error("unable to send processed message loss event. Error: ".concat(o)),this.connectionTracker.trackError("trouter.processed_message_loss",o,!1);}},t.prototype.sendAllocateRequest=function(t){var e=this;this.connectionAttempt++,this.connectionTracker.trackNewConnection();var n,i=this.options.trouterUrl,r=this.reconnectParams,s="string"==typeof(null===r||void 0===r?void 0:r.se)?parseInt(r.se,10):"number"==typeof(null===r||void 0===r?void 0:r.se)?r.se:void 0;s&&s<=Date.now()+36e5&&(this.logger.warn("Dropping expired cached connection parameters: ".concat(new Date(s))),this.reconnectParams=r=void 0),r&&r.serviceUrl!==i&&(this.logger.warn("Dropping cached connection parameters for a different environment (".concat(r.serviceUrl,", now ").concat(i,")")),this.reconnectParams=r=void 0),(null===r||void 0===r?void 0:r.reconnectUrl)&&(i=r.reconnectUrl),n=r?c(c({},r),{serviceUrl:void 0,reconnectUrl:void 0}):null,i=(0, S.adaptUrl)(i,"v4a"),i=this.appendCorrelationIds(i,!1),i=this.appendEndpointId(i,!1),n&&(i+="&".concat(this.buildQuery(n)),n.v||(i+="&v=".concat("v4"))),i=this.options.rewriteUrlForProxy(i);var a=new Request(i,{method:"POST",mode:"cors",headers:new Headers(c(c({"Content-Type":"text/plain"},this.options.extraConnectionHeaders),o(t,this.usingLegacyTokenApi)))});this.logger.info("sendAllocateRequest: POST ".concat(i)),this.connectionTracker.trackStart("allocation");var u,h=Date.now(),d=-1,p=!1;(0, l.fetchWithTimeout)(a,this.timeoutOptions.fetchTimeoutMs).then(function(t){var n;if(d=t.status,!t.ok)throw u=null!==(n=t.headers.get("www-authenticate"))&&void 0!==n?n:void 0,p="1"===t.headers.get("x-trouter-skypetoken-deprecated"),e.logger.warn("Allocation request got response status ".concat(t.status,", www-authenticate header was ").concat(u?"not empty":"empty")),new Error(t.statusText);var o=t.headers.get("content-type");if(!o||"application/json"!==o&&!o.startsWith("application/json;"))throw new Error("Content-type '".concat(o,"' is unexpected"));return e.connectionTracker.trackEnd("allocation"),t.json()}).then(function(n){e.unauthorizedErrorCount=0,e.onAllocationResponse(n,t);}).catch(function(t){e.connectingErrorsInRow++;var n="".concat(t).concat(d>=0?", status code ".concat(d):"");if(e.logger.error("".concat(e.connectingErrorsInRow," failed connecting attempt(s) in a row. ").concat(n)),e.connectionTracker.trackError("allocation",n),p){var o="Skypetoken deprecated response, not retrying any further";return e.logger.error(o),e.connectionTracker.trackError("allocation",o),void e.fsm.onTerminalError()}if(401===d&&e.unauthorizedErrorCount++,!e.canRetryTokenFetchRequest(e.unauthorizedErrorCount)){var o="getToken retry limit hit, reached terminal error state";return e.connectionTracker.trackError("allocation",o),void e.fsm.onTerminalError()}if(-1!==d||e.isNavigatorOnline){if(e.reconnectParams&&e.connectingErrorsInRow>=e.connectingErrorsThreshold)if(d>=400&&d<=599)e.resetReconnectParamsOnErrorThreshold();else if(e.reconnectParams.reconnectUrl&&e.connectingErrorsInRow%3==0){e.logger.warn("".concat(e.connectingErrorsInRow," connection attempts, testing nominal service URL"));var i=Math.min(e.timeoutOptions.connectionTimeoutMs-(Date.now()-h)-500,e.timeoutOptions.fetchTimeoutMs);return void e.testNominalUrlConnectivity(i).then(function(t){e.connectionTracker.trackProgress("nomcheck",t?"ok":"failed"),t?(e.logger.warn("Nominal service URL is reachable, erasing cached reconnect URL"),e.reconnectParams&&delete e.reconnectParams.reconnectUrl):e.logger.warn("Nominal service URL is not reachable either, keeping cached reconnect URL"),e.fsm.onAllocationFailed(!1,void 0);},function(){e.fsm.onAllocationFailed(!1,void 0);})}}else e.logger.info("Expected failure, the browser says it is not online at the moment");e.fsm.onAllocationFailed(401===d,u);});},t.prototype.testNominalUrlConnectivity=function(t){var e=this;if(t<1e3)return this.logger.warn("There is no time left to reasonably perform the nominal service URL connectivity check (".concat(t," ms), falling back to assuming that the connectivity is fine")),Promise.resolve(!0);var n;try{var o=new URL(this.options.trouterUrl);o.pathname="/",o.search="?"+this.buildQuery({check:Date.now(),cor_id:encodeURIComponent(this.options.clientCorrelationID),epid:encodeURIComponent(this.options.endpointId?this.options.endpointId:""),tc:encodeURIComponent((0,l.toJson)(this.clientInfo))}),n=new Request(this.options.rewriteUrlForProxy(o.toString()),{method:"GET",headers:{Accept:"text/plain"}});}catch(t){return this.logger.warn("Nominal service URL connectivity test request could not be created (".concat(t,"), falling back to assuming that the connectivity is fine")),Promise.resolve(!0)}return (0, l.fetchWithTimeout)(n,t).then(function(t){if(200!==t.status)throw new Error("Not 200 OK: ".concat(t.status," ").concat(t.statusText));return t.text()}).then(function(t){if("Trouter"!==t)throw new Error('Not "Trouter": '.concat(t.substring(0,16)).concat(t.length>16?"...":""));return !0}).catch(function(t){return e.logger.error("Nominal service URL connectivity test failed: ".concat(t)),!1})},t.prototype.sendPingRequest=function(){var t=this;if(this.socket&&void 0===this.pingResponseTimerId)try{this.logger.debug("emitting ping event");var e=!1;this.socket.emit("ping",function(){!0!==e&&t.onPingResponse();}),this.pingResponseTimerId=setTimeout(function(){t.logger.error("Ping response timeout is fired"),e=!0,t.clearPingResponseTimer(),t.fsm.onPingResponseTimeout();},this.timeoutOptions.pongTimeoutMs);}catch(t){var n=r(t);this.logger.error("unable to send ping. Error: ".concat(n)),this.connectionTracker.trackError("ping",n,!1);}},t.prototype.connectV4c=function(t,e){var n,o,i,r,s,a,u=this.options.ioOptions?c({},this.options.ioOptions):new R;u["force new connection"]=!0,u.reconnect=!1,(null===(n=this.reconnectParams)||void 0===n?void 0:n.serviceUrl)&&(0, S.adaptUrl)(this.reconnectParams.serviceUrl,"v4c")!==(0, S.adaptUrl)(this.options.trouterUrl,"v4c")&&(this.logger.warn("Dropping cached connection parameters for a different environment (".concat(this.reconnectParams.serviceUrl,", now ").concat(this.options.trouterUrl,")")),this.reconnectParams=void 0);var h=null!==(r=null!==(o=(0, S.redirectUrlIfPresent)(e))&&void 0!==o?o:"redirect-no-host"!==(null===e||void 0===e?void 0:e.kind)?null===(i=this.reconnectParams)||void 0===i?void 0:i.reconnectUrl:void 0)&&void 0!==r?r:this.options.trouterUrl,d=(0, S.adaptUrl)(h,"v4c");u["skipped handshake data"]={timeout:70,websocketUrl:d},u.query=this.buildV4cUrlParams(),u.rewriteUrlForProxy=this.options.rewriteUrlForProxy;try{if(this.stopSocketIo(),this.transportTypeName="websocket",this.socket=(null!==(s=this.options.io)&&void 0!==s?s:w).connect(this.options.trouterUrl,u),void 0===this.socket)throw new Error("failed to create Socket.io object");var l=null===(a=this.audienceSubscriptionState)||void 0===a?void 0:a.increaseCvAndGetEventObject();this.attachSocketIoHandlers(this.socket,t,void 0,l);}catch(t){this.logger.error("".concat(t)),this.connectionTracker.trackError("v4c","".concat(t)),this.fsm.onV4cException();}},t.prototype.sendV4cAuthenticationEvent=function(t){var e,n={headers:c(c({},this.options.extraConnectionHeaders),o(t,this.usingLegacyTokenApi)),connectparams:(0, S.reconnectParamsWithoutUrls)(this.reconnectParams)};null===(e=this.socket)||void 0===e||e.emit(g.USER_AUTHENTICATE_EVENT_NAME,n);},t.prototype.setUserActivityState=function(t){var e=t.state!==this.userActivityState.state;this.userActivityState=t,e?(this.logger.info("Changing user activity state to '".concat(t.toEventJSON(),"'")),this.fsm.onSetNewUserActivityState()):(this.logger.debug("Not changing the same user activity state '".concat(t.toEventJSON(),"'")),this.manager.onUserActivityStateAccepted(t.correlationVector.value()));},t.prototype.sendUserActivityState=function(t,e){this.userActivityState.state!==m.UserActivityState.Unknown&&("websocket"===this.transportTypeName&&e?t===y.UserActivityEventReason.Connected?this.sendUserActivityStateMultiple(2):this.sendUserActivityStateMultiple(1):"xhr-polling"===this.transportTypeName&&t===y.UserActivityEventReason.Modified&&this.fsm.forceReconnect("user activity/force reconnect"));},t.prototype.setAudienceSubscriptionsAsync=function(t,e){var n=this.audienceSubscriptionState;if(this.audienceSubscriptionState=t,this.transportTypeName===this.WEBSOCKET_TRANSPORT_NAME)return this.setAudienceSubscriptionsInternalAsync(t.increaseCvAndGetEventObject(),e);if(this.transportTypeName===this.XHR_POLLING_TRANSPORT_NAME){var o=this.setAudienceSubscriptionsLongpollInternalAsync(t.increaseCvAndGetEventObject(),e,n);return this.fsm.forceReconnect("set audience subscription force reconnect"),o}throw new Error("set audience subscription executed on an unknown transport")},t.prototype.setAudienceSubscriptionsUnsafeAsync=function(t){if(t)return this.transportTypeName===this.WEBSOCKET_TRANSPORT_NAME?this.setAudienceSubscriptionsInternalAsync(t,15e3):void 0},t.prototype.setAudienceSubscriptionsInternalAsync=function(t,e){return a(this,void 0,void 0,function(){var n,o,i=this;return u(this,function(r){switch(r.label){case 0:return this.logger.info("[WebSocket] Audience subscription set requested."),n=new A("audience.subscribe"),n.args=t,[4,new Promise(function(o){var r=!1,s=setTimeout(function(){return r=!0,o(i.buildAudienceSubscriptionsTimeoutResponse(t))},e);i.sendDownstreamEvent(n,function(t,e){r||(clearTimeout(s),i.logger.debug("[Websocket] Audience subscription response: ".concat(e)),i.pendingAudienceSubscription&&i.onAudienceSubscriptionResult(e),o(e));});})];case 1:return o=r.sent(),this.manager.onAudiencesSetResolved(o,t.cv),[2,o]}})})},t.prototype.setAudienceSubscriptionsLongpollInternalAsync=function(t,e,n){var o;return a(this,void 0,void 0,function(){var i,r,s,c,a,h,d=this;return u(this,function(u){switch(u.label){case 0:return this.logger.info("[XHR Polling] Audience subscription set requested."),this.pendingAudienceSubscription&&(this.logger.error("Racing audience subscriptions occured. This situation resolves into undefined scenario and/or nasal demons."),clearTimeout(this.pendingAudienceSubscription.timeoutId)),0===t.audiences.length?[2,this.handleAudienceUnsubscribeLongpoll(t.cv,n)]:[4,new Promise(function(n){var o=setTimeout(function(){return d.pendingAudienceSubscription=void 0,n(d.buildAudienceSubscriptionsTimeoutResponse(t))},e);d.pendingAudienceSubscription={audienceSetResolve:n,timeoutId:o};})];case 1:return i=u.sent(),this.manager.getState()===m.TrouterState.Unknown||this.transportTypeName===this.WEBSOCKET_TRANSPORT_NAME?[2,i]:(r=i.responses[0],(null===r||void 0===r?void 0:r.result.audienceSubscriptionState)===this.AUDIENCE_SUBSCRIPTION_RESULT_BAD_REQUEST?(this.clearAudienceSubscriptionStateQueryParam(),this.manager.onAudiencesSetResolved(i,t.cv),[2,i]):(s=i.responses.find(function(e){return e.audienceId===t.audiences[0].id}),(null===s||void 0===s?void 0:s.result.audienceSubscriptionState)===this.AUDIENCE_SUBSCRIPTION_RESULT_ERROR?(this.clearAudienceSubscriptionStateQueryParam(),this.manager.onAudiencesSetResolved(i,t.cv),[2,i]):(c=(null===(o=null===n||void 0===n?void 0:n.audienceSubscriptionModel.audienceSubscriptions[0])||void 0===o?void 0:o.id)!==(null===r||void 0===r?void 0:r.audienceId),n&&c&&(a=this.mapToSyntheticAudienceSubscriptionResponses(n.audienceSubscriptionModel.audienceSubscriptions,this.AUDIENCE_SUBSCRIPTION_RESULT_UNSUBSCRIBED,200),(h=i.responses).push.apply(h,a)),this.manager.onAudiencesSetResolved(i,t.cv),[2,i])))}})})},t.prototype.clearAudienceSubscriptionStateQueryParam=function(){var t,e,n;(null===(n=null===(e=null===(t=this.socket)||void 0===t?void 0:t.socket)||void 0===e?void 0:e.options)||void 0===n?void 0:n.query)&&(this.socket.socket.options.query=this.socket.socket.options.query.replace(this.AUDIENCE_SUBSCRIPTION_STATE_QUERY_PARAM_REGEX,""));},t.prototype.handleAudienceUnsubscribeLongpoll=function(t,e){var n;this.audienceSubscriptionState=void 0;var o={responses:[]};if(e){var i=this.mapToSyntheticAudienceSubscriptionResponses(e.audienceSubscriptionModel.audienceSubscriptions,this.AUDIENCE_SUBSCRIPTION_RESULT_UNSUBSCRIBED,200);(n=o.responses).push.apply(n,i);}return this.manager.onAudiencesSetResolved(o,t),o},t.prototype.buildAudienceSubscriptionsTimeoutResponse=function(t){return this.logger.error("Audience subscription attempt has timed out."),{responses:this.mapToSyntheticAudienceSubscriptionResponses(t.audiences,this.AUDIENCE_SUBSCRIPTION_RESULT_TIMEOUT)}},t.prototype.mapToSyntheticAudienceSubscriptionResponses=function(t,e,n){return t.map(function(t){return {audienceId:t.id,result:{audienceSubscriptionState:e,responseStatus:n}}})},t.prototype.expediteBackoff=function(){this.tokenBackoff.expediteIfPending();},t.prototype.sendRegisterRequest=function(){var t=this;if(!this.options.registration||!this.registrarClient)throw new Error("Internal error - options.registration is undefined");if(!this.allocateResult)throw new Error("Allocate result is undefined in sendRegisterRequest()");this.logger.info("sending register request");var e=new l.Timespan;this.connectionTracker.trackStart("registration");var n=this.getRegistrationTtl()[0];this.registrarClient.register({appId:this.options.registration.pnhAppId,aesKey:"",languageId:"en-US",platform:this.options.registration.platform,templateKey:this.options.registration.pnhTemplateKey,platformUIVersion:this.options.registration.platformUIVersion,productContext:this.options.registration.productContext},{TROUTER:[{context:this.options.registration.context,path:this.allocateResult.surl,ttl:n}]}).then(function(){t.logger.info("Register request successful"),t.connectionTracker.trackEnd("registration"),t.fsm.onRegistrationSucceeded(),t.connectionTracker.sendTelemetry(p.ClientEventName.Registration,{duration:e.duration},[]);}).catch(function(n){t.logger.error("Register request failed. Error: ".concat(n)),t.connectionTracker.trackError("registration",s(n)),t.fsm.onRegistrationFailed(),t.connectionTracker.sendTelemetry(p.ClientEventName.Registration,{duration:e.duration},[]);});},t.prototype.sendUnregisterRequest=function(){var t=this;this.logger.info("sending unregister request");var e=new l.Timespan;if(!this.options.registration||!this.registrarClient)throw new Error("Internal error - options.registration is undefined");this.connectionTracker.trackStart("unregistration"),this.registrarClient.unregister().then(function(){t.logger.info("Unregister request successful"),t.connectionTracker.trackEnd("unregistration"),t.fsm.onUnregistrationDone(),t.connectionTracker.sendTelemetry(p.ClientEventName.Unregistration,{duration:e.duration},[]);}).catch(function(n){t.logger.error("Unregister request failed. Error: ".concat(n)),t.connectionTracker.trackError("unregistration",s(n)),t.fsm.onUnregistrationDone(),t.connectionTracker.sendTelemetry(p.ClientEventName.Unregistration,{duration:e.duration},[]);});},t.prototype.resetTokenBackoff=function(){this.tokenBackoff.reset();},t.prototype.cancelPendingRegistrationRequests=function(){this.registrarClient&&this.registrarClient.cancelPendingRequests();},t.prototype.clearSentEventTimers=function(){var t=Object.keys(this.pendingSentEventTimers);if(t.length>0){this.logger.debug("Clearing all pending downstream events related timers");for(var e=0,n=t;e<n.length;e++){var o=n[e];this.clearSentEventTimer(Number(o));}}},t.prototype.restartIncallModeTimer=function(){var t=this;this.clearIncallModeTimerId(),this.logger.debug("Restarting incall mode timer"),this.incallModeTimerId=setTimeout(function(){t.logger.info("Call mode timer fired"),t.fsm.onIncallModeTimer();},this.options.incallModeTimeoutMs);},t.prototype.enterIncallMode=function(){this.logger.info("Entering incall mode"),this.timeoutOptions=this.options.incallTimeoutOptions,this.tokenBackoff.setMaxBackoffMs(this.timeoutOptions.maxBackoffMs),this.inIncallMode=!0;},t.prototype.exitIncallMode=function(){this.logger.info("Exiting incall mode"),this.clearIncallModeTimerId(),this.timeoutOptions=this.options.timeoutOptions,this.tokenBackoff.setMaxBackoffMs(this.timeoutOptions.maxBackoffMs),this.inIncallMode=!1;},t.prototype.isIncallMode=function(){return this.inIncallMode},t.prototype.sendDisconnectTelemetryEvent=function(t){var e={reason:t,serverClosed:!this.fsm.isActive()};this.connectionTracker.trackDisconnected(e),this.connectionTracker.clearConnectedInfo();},t.prototype.forceReconnectDueToNoRegistration=function(){this.fsm.forceReconnect("force reconnect due to no registration");},t.prototype.resetReconnectParamsOnErrorThreshold=function(){this.logger.warn("".concat(this.connectingErrorsInRow," connection attempts, server-side failure: erasing cached connection parameters")),this.reconnectParams=void 0;},t.prototype.onSocketConnecting=function(t){this.logger.info("onSocketConnecting(".concat(t,")")),this.transportTypeName=t,this.connectionTracker.trackProgress("connecting",this.transportTypeName),this.fsm.onConnecting();},t.prototype.onSocketConnect=function(t){this.logger.info("onSocketConnect"),this.fsm.onSocketConnect(t);},t.prototype.onSocketConnectFailed=function(t){this.logger.error("onSocketConnectFailed"),this.connectionTracker.trackError("connect_failed",t,!0,this.transportTypeName?this.transportTypeName:this.UNKNOWN_TRANSPORT),this.fsm.onConnectingFailed();},t.prototype.onSocketDisconnect=function(t){var e=this.connectionTracker.getSessionLength()||0,n=f.DisconnectReason.fromRawReason(t);this.logger.error("onSocketDisconnect, reason: ".concat(n.reason)),"dup"===n.reason&&"dup"===this.lastDisconnectReason&&e<this.options.duplicateDisconnectThresholdMs&&(this.logger.warn("Socket was closed by server as Duplicate for the second time in a row "+"after ".concat(e," ms which is below the threshold of ")+"".concat(this.options.duplicateDisconnectThresholdMs," ms. Resetting cached ")+"connection parameters and making a new allocation."),this.reconnectParams=void 0),this.lastDisconnectReason=n.reason,this.fsm.onSocketDisconnect(n),this.connectionExpireTimestampInSecs=void 0;},t.prototype.onSocketReconnect=function(){this.logger.error("onSocketReconnect"),this.fsm.onTrouterConnected();},t.prototype.onSocketReconnectFailed=function(t){this.logger.error("onSocketReconnectFailed with '".concat(t,"'")),this.fsm.onSocketDisconnect(f.DisconnectReason.fromSocketIoEventData("reconnecterror",t));},t.prototype.onSocketReconnecting=function(){this.logger.error("onSocketReconnecting");},t.prototype.onSocketError=function(t){this.logger.error("onSocketError with '".concat((0, l.toJson)(t),"'")),this.fsm.isConnecting()&&++this.connectingErrorsInRow>=this.connectingErrorsThreshold&&this.resetReconnectParamsOnErrorThreshold(),this.connectionTracker.trackError("connectSocket",i(t)),this.fsm.onSocketDisconnect(f.DisconnectReason.fromSocketIoEventData("socketerror",t));},t.prototype.onSocketMessage=function(t){var e,n=this;this.logger.debug("onSocketMessage");var o;try{o=new E(t,this.logger);var i=null===(e=o.headers)||void 0===e?void 0:e["X-Microsoft-Skype-Chain-ID"],c=i?" Chain-Id ".concat(i):"";this.logger.info("Received request N ".concat(o.id).concat(c," CV ").concat(o.correlationVector," to '").concat(o.url,"'")),o.startTS=Date.now(),o.url&&this.urlPath&&o.url.startsWith(this.urlPath)&&(o.shortUrl=o.url.substring(this.urlPath.length));}catch(t){var a=r(t);return this.logger.error("unable to parse request. Error: ".concat(a)),this.connectionTracker.trackRequest(void 0,a),void this.connectionTracker.sendResponseError("unable to parse request, error: ".concat(t))}o.timeoutTimerId=setTimeout(function(){if(!o.replied){n.logger.error("Request ".concat(o.id," timed out"));var t=new p.ResponseData(o.id);t.status=504,t.headers={"Trouter-Responder":"ClientLib"},n.sendResponse(o,t),o.timedout=!0;}},this.timeoutOptions.requestTimeoutMs);try{this.connectionTracker.trackRequest(o),this.fsm.onDownstreamRequest(o);}catch(t){this.logger.error("exception in socket.on message. Error: ".concat(r(t))),this.connectionTracker.sendResponseError(s(t),o,void 0);}},t.prototype.onTrouterConnected=function(t,e,n){var o,i,r,s,a=this;if((0, S.isV4ConnectEvent)(t)){var u=t;this.allocateResult=c(c({},u),{ttl:t.ttl.toString()}),this.populateAndCacheReconnectParams(u,u.reconnectUrl),this.populateConnectionStateFields(u);}else if(!this.allocateResult)return void this.logger.error("Invalid internal state - received onTrouterConnected while allocateResult is not set");this.connectingErrorsInRow=0,this.logger.info("onTrouterConnected: ".concat(this.allocateResult.url)),"xhr-polling"===this.transportTypeName&&e&&this.manager.onUserActivityStateAccepted(e.cv),(null===(r=null===(i=null===(o=this.socket)||void 0===o?void 0:o.socket)||void 0===i?void 0:i.options)||void 0===r?void 0:r.query)&&(this.socket.socket.options.query+="&connected=true"),this.urlPath=this.allocateResult.url.replace(/https?:\/\/([A-z0-9\:\$\-\_\.\+\!\*\"\(\)\,]*)\//,"/");var h=this.connectedUrl!==this.allocateResult.url;this.connectedUrl=this.allocateResult.url,this.connectionExpireTimestampInSecs=(0, l.calculateExpireTsInSec)((0, S.ensureNumber)(t.ttl)),this.connectionTracker.trackEnd("connectSocket"),this.connectionTracker.trackConnected(h,this.transportTypeName?this.transportTypeName:this.UNKNOWN_TRANSPORT),null===(s=this.setAudienceSubscriptionsUnsafeAsync(n))||void 0===s||s.catch(function(t){return a.logger.error("Re-subscribe to audiences has failed with ".concat(t))}),this.fsm.onTrouterConnected();},t.prototype.onTrouterReconnect=function(t){var e=t.target;this.logger.info("onTrouterReconnect target: ".concat(e)),"self"===e?this.fsm.onReconnectRequired(!0,h.ServerInitiated):this.fsm.onReconnectRequired(!1,h.ServerInitiated,t);},t.prototype.onTrouterMessageLoss=function(t){this.logger.debug("onTrouterMessageLoss"),this.fsm.onTrouterMessageLost(t.droppedIndicators);},t.prototype.onAudienceSubscriptionResult=function(t){this.logger.info("onAudienceSubscriptionResult"),this.pendingAudienceSubscription&&(clearTimeout(this.pendingAudienceSubscription.timeoutId),this.pendingAudienceSubscription.audienceSetResolve(t),this.pendingAudienceSubscription=void 0);},t.prototype.buildV4cUrlParams=function(){var t={};return t.tc=encodeURI((0, l.toJson)(this.clientInfo)),t.timeout=Math.floor(this.timeoutOptions.pingTimeoutMs/1e3),this.options.endpointId&&(t.epid=this.options.endpointId),this.appendConnectedClientIds(this.buildQuery(t),!0)},t.prototype.attachSocketIoHandlers=function(t,e,n,o){var i=this;t.on("connecting",function(t){i.onSocketConnecting(t);}),t.on("connect",function(){i.onSocketConnect(e);}),t.on("connect_failed",function(t){i.onSocketConnectFailed(t);}),t.on("close_during_connecting",function(t){i.onSocketConnectFailed(t);}),t.on("disconnect",function(t){i.onSocketDisconnect(t);}),t.on("reconnect",function(){i.onSocketReconnect();}),t.on("reconnect_failed",function(t){i.onSocketReconnectFailed(t);}),t.on("reconnecting",function(){i.onSocketReconnecting();}),t.on("error",function(t){i.onSocketError(t);}),t.on("message",function(t){i.onSocketMessage(t);}),t.on("trouter.connected",function(t){i.onTrouterConnected(t,n,o);}),t.on("trouter.reconnect",function(t){i.onTrouterReconnect(t);}),t.on("trouter.message_loss",function(t){i.onTrouterMessageLoss(t);}),t.on("audience.subscriptionresult",function(t,e){i.onAudienceSubscriptionResult(e);});},t.prototype.onNavigatorOnlineStatusUpdate=function(){var t=window.navigator.onLine;this.logger.debug("Browser online status update - new state: ".concat(t,", previously: ").concat(this.isNavigatorOnline)),t&&!this.isNavigatorOnline?(this.isNavigatorOnline=!0,this.tokenBackoff.expediteIfPending(),this.connectionTracker.trackProgress("browserNet","online")):!t&&this.isNavigatorOnline&&(this.isNavigatorOnline=!1,this.connectionTracker.trackProgress("browserNet","offline"));},t.prototype.onAllocationResponse=function(t,e){this.logger.info("Received allocation response ".concat(JSON.stringify(t))),this.allocateResult=t,this.populateAndCacheReconnectParams(this.allocateResult,"".concat(this.allocateResult.socketio,"v4/a")),this.populateConnectionStateFields(this.allocateResult),this.fsm.onAllocationSucceed(e);},t.prototype.populateAndCacheReconnectParams=function(t,e){this.reconnectParams=c({serviceUrl:this.options.trouterUrl,reconnectUrl:e},t.connectparams),this.manager.onConnectionParametersUpdated(this.reconnectParams);},t.prototype.populateConnectionStateFields=function(t){var e,n,o="string"==typeof t.ttl?parseInt(t.ttl,10):t.ttl;if(this.connectionExpireTimestampInSecs=(0, l.calculateExpireTsInSec)(o),this.connectionId=null!==(e=t.id)&&void 0!==e?e:"",this.connectedClientId=t.ccid,this.logger.debug("connected client id set {connectedClientId:".concat(this.connectedClientId,"}")),this.c2cUrlBase=null!==(n=t.curlb)&&void 0!==n?n:"",""===this.c2cUrlBase){var i=t.surl.indexOf("://");i>=0&&(i=t.surl.indexOf("/",i+3))>=5&&":3443"===t.surl.substr(i-5,5)&&(this.c2cUrlBase=t.surl.substr(0,i-5));}},t.prototype.onPingResponse=function(){this.logger.debug("onPingResponse"),this.connectionTracker.increasePingResponseCount(),this.clearPingResponseTimer(),this.fsm.onPingResponse();},t.prototype.clearPingResponseTimer=function(){void 0!==this.pingResponseTimerId&&(clearTimeout(this.pingResponseTimerId),this.pingResponseTimerId=void 0);},t.prototype.buildQuery=function(t){for(var e=[],n=0,o=Object.keys(t);n<o.length;n++){var i=o[n];void 0!==t[i]&&e.push("".concat(i,"=").concat(t[i]));}return e.join("&")},t.prototype.appendConnectedClientIds=function(t,e){var n="";t.includes("ccid=")||(n="ccid=".concat(this.connectedClientId,"&")),this.domId&&(n+="dom=".concat(this.domId,"&")),n.length>0&&(n=n.slice(0,-1));var o=e||t.includes("?")?"&":"?";return this.appendCorrelationIds(t+o+n,e)},t.prototype.appendEndpointId=function(t,e){var n=e||t.includes("?")?"&":"?";return !t.includes("epid")&&this.options.endpointId?"".concat(t).concat(n,"epid=").concat(this.options.endpointId):t},t.prototype.appendCorrelationIds=function(t,e){var n=e||t.includes("?")?"&":"?";return t.includes("cor_id")?t:"".concat(t).concat(n,"cor_id=").concat(this.options.clientCorrelationID)+"&con_num=".concat(this.clientID,"_").concat(this.connectionAttempt)},t.prototype.safeString=function(t){return "string"==typeof t?t:""},t.prototype.sendResponse=function(t,e){var n,o,i;if(t.timedout)return this.logger.error("Request ".concat(t.id," already timed out")),1;if(t.replied)return this.logger.error("Response for request ".concat(t.id," already sent")),2;clearTimeout(t.timeoutTimerId),t.timeoutTimerId=void 0,t.replied=!0,e.headers=null!==(n=e.headers)&&void 0!==n?n:{};var s=t.correlationVector;this.logger.info("Sending response N ".concat(t.id," CV ").concat(s," with status ").concat(e.status)),s&&(e.headers[C]=s),(null===(o=t.headers)||void 0===o?void 0:o["trouter-request"])&&(e.headers["trouter-request"]=t.headers["trouter-request"]);var c=Date.now()-t.startTS;if(e.headers["trouter-client"]=(0, l.toJson)({cd:c}),(null===(i=t.headers)||void 0===i?void 0:i["trouter-is-broadcast"])&&(e.headers["trouter-is-broadcast"]=t.headers["trouter-is-broadcast"]),this.logger.debug("response: ".concat((0, l.toJson)(e))),!this.socket)return this.connectionTracker.sendResponseError("no socket",t,e),4;try{return this.socket.send((0,l.toJson)(e)),e.sentTS=Date.now(),t.incrementCorrelationVector(),this.connectionTracker.trackResponse(t,c,e),"websocket"===this.transportTypeName&&this.sendPingRequest(),0}catch(n){var a="unable to send data on response.end. Error: ".concat(r(n));return this.logger.error(a),this.connectionTracker.sendResponseError(a,t,e),4}},t.prototype.sendUserActivityStateMultiple=function(t){var e=this,n=new A("user.activity"),o=this.userActivityState.increaseCvAndGetEventObject();n.args=o,this.logger.debug("Sending user activity '".concat(this.userActivityState.toEventJSON(),"', remaining ").concat(t-1));var i=!1;this.sendDownstreamEvent(n,function(){if(!0!==i&&(e.logger.info("User activity state: ".concat(o.state,", cv: ").concat(o.cv," accepted")),e.manager.onUserActivityStateAccepted(o.cv),e.clearSentEventTimer(n.timeoutTimerId),t>1)){var r=setTimeout(function(){e.clearSentEventTimer(r),e.sendUserActivityStateMultiple(t-1);},e.options.userActivitySecondResendDelayMs);e.registerSentEventTimer(r,"user.activity/resend");}}),n.timeoutTimerId=setTimeout(function(){e.logger.error("Activity state response timeout is fired"),i=!0,e.fsm.onActivityStateResponseTimeout(),e.clearSentEventTimer(n.timeoutTimerId);},this.timeoutOptions.userActivityResponseTimeoutMs),this.registerSentEventTimer(n.timeoutTimerId,"user.activity/response");},t.prototype.sendDownstreamEvent=function(t,e){this.logger.debug("Sending downstream event ".concat(t.name)),this.socket&&this.socket.emit(t.name,t.args,e);},t.prototype.registerSentEventTimer=function(t,e){this.logger.debug("registering timer ".concat(t," -> ").concat(e)),this.pendingSentEventTimers[t]=e;},t.prototype.clearSentEventTimer=function(t){var e=this.pendingSentEventTimers[t];this.logger.debug("clearing timer ".concat(t," -> ").concat(e)),delete this.pendingSentEventTimers[t],clearTimeout(t);},t.prototype.getRegistrationTtl=function(){var t,e,n=(0, l.calculateTtlInSec)(this.connectionExpireTimestampInSecs);if(this.logger.debug("Current connectionID will expire in ".concat(n," seconds")),(null===(t=this.options.registration)||void 0===t?void 0:t.registrarTtlSec)&&n>0){var o=this.options.registration.registrarTtlSec<n;return [Math.min(this.options.registration.registrarTtlSec,n),o]}return (null===(e=this.options.registration)||void 0===e?void 0:e.registrarTtlSec)?[this.options.registration.registrarTtlSec,!1]:n>0?[n,!1]:[3600,!1]},t.prototype.clearIncallModeTimerId=function(){void 0!==this.incallModeTimerId&&(this.logger.debug("Clearing in-call mode timer"),clearTimeout(this.incallModeTimerId),this.incallModeTimerId=void 0);},t.prototype.applyConnectionTrackerOptions=function(t){try{t.eventLogger&&"function"==typeof t.eventLogger.logEvent?(this.connectionTracker.mergeSettings(t.telemetrySettings),this.connectionTracker.enable(t.eventLogger)):this.logger.warn("Trouter client event logging disabled due to invalid configuration.");}catch(t){this.logger.warn("Trouter client event logging disabled. Error: ".concat(r(t))),this.connectionTracker.disable();}},t.prototype.canRetryTokenFetchRequest=function(t){var e=this.options.retryLimitOnTokenFetch;return null===e||void 0===e||(t<e||(this.logger.warn("Reached limit on maximum number of token fetch request. Current count: ".concat(t,", retry limit: ").concat(e)),!1))},t}();e.TrouterConnection=U;},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.MessageHandlerRegistry=void 0;var o=n(1),i=n(0),r=function(){function t(t){this.messageHandlers=[],this.logger=new i.Logger("MessageHandlers",t);}return t.prototype.register=function(t){if(this.messageHandlers.some(function(e){return e===t}))throw new Error("Registering the same handler twice is not allowed");this.messageHandlers.push(t);},t.prototype.clear=function(){this.logger.debug("Clearing message handlers"),this.messageHandlers=[];},t.prototype.active=function(){return this.messageHandlers.length>0},t.prototype.handleMessage=function(t){for(var e={resultCode:o.UNHANDLED_MESSAGE_ACK,isHandled:!1},n=0,i=this.messageHandlers;n<i.length;n++){var r=i[n],s=this.safeExecuteHandle(r,t);if(void 0!==s&&(void 0===s.isHandled||s.isHandled))return void 0===s.resultCode&&(s.resultCode=o.HANDLED_MESSAGE_ACK),s}return e},t.prototype.safeExecuteHandle=function(t,e){try{return t.handleMessage(e)}catch(t){return void this.logger.warn("Trouter message handler threw an exception: ".concat(t))}},t}();e.MessageHandlerRegistry=r;},function(t,e,n){function o(t){var e,n=this;return function(o){return i(n,void 0,void 0,function(){return r(this,function(n){return o&&(e=void 0),[2,new Promise(function(n,i){t(o).then(function(t){e=t,n(t);}).catch(function(t){void 0!==e&&e.length>0&&n(e),i(t);});})]})})}}var i=this&&this.__awaiter||function(t,e,n,o){function i(t){return t instanceof n?t:new n(function(e){e(t);})}return new(n||(n=Promise))(function(n,r){function s(t){try{a(o.next(t));}catch(t){r(t);}}function c(t){try{a(o.throw(t));}catch(t){r(t);}}function a(t){t.done?n(t.value):i(t.value).then(s,c);}a((o=o.apply(t,e||[])).next());})},r=this&&this.__generator||function(t,e){function n(t){return function(e){return o([t,e])}}function o(n){if(i)throw new TypeError("Generator is already executing.");for(;c&&(c=0,n[0]&&(a=0)),a;)try{if(i=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(s=a.trys,!(s=s.length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(6===n[0]&&a.label<s[1]){a.label=s[1],s=n;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(n);break}s[2]&&a.ops.pop(),a.trys.pop();continue}n=e.call(t,a);}catch(t){n=[6,t],r=0;}finally{i=s=0;}if(5&n[0])throw n[1];return {value:n[0]?n[1]:void 0,done:!0}}var i,r,s,c,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return c={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c};Object.defineProperty(e,"__esModule",{value:!0}),e.addCacheAsBackupTo=void 0,e.addCacheAsBackupTo=o;},function(t,e,n){var o=this&&this.__awaiter||function(t,e,n,o){function i(t){return t instanceof n?t:new n(function(e){e(t);})}return new(n||(n=Promise))(function(n,r){function s(t){try{a(o.next(t));}catch(t){r(t);}}function c(t){try{a(o.throw(t));}catch(t){r(t);}}function a(t){t.done?n(t.value):i(t.value).then(s,c);}a((o=o.apply(t,e||[])).next());})},i=this&&this.__generator||function(t,e){function n(t){return function(e){return o([t,e])}}function o(n){if(i)throw new TypeError("Generator is already executing.");for(;c&&(c=0,n[0]&&(a=0)),a;)try{if(i=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(s=a.trys,!(s=s.length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(6===n[0]&&a.label<s[1]){a.label=s[1],s=n;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(n);break}s[2]&&a.ops.pop(),a.trys.pop();continue}n=e.call(t,a);}catch(t){n=[6,t],r=0;}finally{i=s=0;}if(5&n[0])throw n[1];return {value:n[0]?n[1]:void 0,done:!0}}var i,r,s,c,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return c={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c};Object.defineProperty(e,"__esModule",{value:!0}),e.TrouterManager=e.AudienceSubscriptionState=e.UserActivityObject=void 0;var r=n(3),s=n(2),c=n(4),a=n(0),u=n(5),h=n(18),d=n(7),l=n(6),p=n(19),g=function(){function t(t,e){this.state=t,this.correlationVector=void 0!==e?e:r.CorrelationVector.extend();}return t.prototype.getStateString=function(){switch(this.state){case s.UserActivityState.Active:return "active";case s.UserActivityState.Inactive:return "inactive";case s.UserActivityState.Unknown:return "unknown";default:return "undefined"}},t.prototype.increaseCvAndGetEventObject=function(){return this.correlationVector.increase(),this.toEventObject()},t.prototype.toEventObject=function(){return {state:this.getStateString(),cv:this.correlationVector.value()}},t.prototype.toEventJSON=function(){return (0, r.toJson)(this.toEventObject())},t}();e.UserActivityObject=g;var f=function(){function t(t,e){void 0===e&&(e=r.CorrelationVector.extend()),this.audienceSubscriptionModel=t,this.correlationVector=e;}return t.prototype.increaseCvAndGetEventObject=function(){return this.correlationVector.increase(),this.toEventObject()},t.prototype.toEventObject=function(){return {audiences:this.audienceSubscriptionModel.audienceSubscriptions,cv:this.correlationVector.value()}},t.prototype.toEventJSON=function(){return (0, r.toJson)(this.toEventObject())},t}();e.AudienceSubscriptionState=f;var v=function(){function t(t,e,n,o,i,c){var h=this;this.logFunc=t,this.options=e,this.tokenProvider=n,this.usingLegacyTokenApi=o,this.listener=i,this.tokenTypeProtocolSelector=function(t,e){return h.options.forceV4aProtocol?"v4a":(0, u.usedProtocol)(t,e)},this.logger=new a.Logger("Manager",t),this.logger.info("Created TrouterManager with options ".concat((0, r.toJson)(this.options))),this.fsm=new p.TrouterManagerFsm(t,this),this.baseEndpointUrl="",this.processedMessageLoss={},this.userActivityObject=new g(s.UserActivityState.Unknown),this.protocolSelector=null!==c&&void 0!==c?c:this.tokenTypeProtocolSelector.bind(this);}return t.prototype.start=function(){this.fsm.start();},t.prototype.stop=function(t){this.fsm.stop(t);},t.prototype.configure=function(t){this.options=t,void 0!==this.firstConnection&&this.firstConnection.configure(t),void 0!==this.secondConnection&&this.secondConnection.configure(t),this.logger.info("Reconfigured TrouterManager with options ".concat((0, r.toJson)(this.options)));},t.prototype.checkConnection=function(t){void 0!==this.firstConnection&&this.firstConnection.checkConnection(t),void 0!==this.secondConnection&&this.secondConnection.checkConnection(t);},t.prototype.resendRegistration=function(){return o(this,void 0,void 0,function(){return i(this,function(t){return void 0!==this.secondConnection?(this.logger.info("Resending registration on the second/new connection"),[2,this.secondConnection.resendRegistration()]):void 0!==this.firstConnection?(this.logger.info("Resending registration on the first/current connection"),[2,this.firstConnection.resendRegistration()]):(this.logger.info("No connection to resend registration on, will be done upon (re)connect"),[2])})})},t.prototype.getServerState=function(){if(void 0!==this.firstConnection)return this.firstConnection.getServerState()},t.prototype.getState=function(){return this.fsm.getState()},t.prototype.isInTerminalState=function(){return this.fsm.getInternalState()===c.TrouterManagerState.TerminalError},t.prototype.reportStateInfo=function(){var t=this.firstConnection?l.State[this.firstConnection.getState()]:"Unknown",e=c.TrouterManagerState[this.fsm.getInternalState()];if(this.secondConnection){var n=l.State[this.secondConnection.getState()];return "Manager ".concat(e,"; 1st ").concat(t,"; 2nd ").concat(n)}return "Manager ".concat(e,"; Connection ").concat(t)},t.prototype.startFirstConnection=function(){var t=new d.TrouterConnection(this.logFunc,this.options,this.configuredTrouterManager(),this.tokenProvider,this.usingLegacyTokenApi,this.userActivityObject,this.protocolSelector,this.audienceSubscriptionState);this.firstConnection=t,this.getConnectionCache().then(function(e){t.start(e);}).catch(function(){});},t.prototype.startSecondConnection=function(t){var e=new d.TrouterConnection(this.logFunc,this.options,this.configuredTrouterManager(),this.tokenProvider,this.usingLegacyTokenApi,this.userActivityObject,this.protocolSelector,this.audienceSubscriptionState);this.secondConnection=e,void 0!==this.firstConnection&&this.firstConnection.disableRegistrationsAndAutoReconnect(),t?this.getConnectionCache().then(function(t){e.start(t);}).catch(function(){}):e.start();},t.prototype.stopFirstConnection=function(t){void 0!==this.firstConnection&&(this.storedFirstConnection=this.firstConnection,this.firstConnection.stop(t),this.firstConnection=void 0);},t.prototype.stopSecondConnection=function(t){void 0!==this.secondConnection&&(this.secondConnection.stop(t),this.secondConnection=void 0);},t.prototype.stopSecondConnectionDelayed=function(){if(void 0!==this.secondConnection){var t=this.secondConnection;this.secondConnection=void 0,this.logger.info("Closing an inactive connection in ".concat(Math.round(this.options.lingeringConnectionDelayMs/1e3),"s")),setTimeout(function(){t.stop(!0);},this.options.lingeringConnectionDelayMs);}},t.prototype.forceStopLingeringConnection=function(){this.storedFirstConnection&&(this.storedFirstConnection.stop(!1),this.storedFirstConnection=void 0);},t.prototype.switchConnections=function(){var t=this.firstConnection;this.firstConnection=this.secondConnection,this.secondConnection=t;},t.prototype.doesSecondConnectionExist=function(){return void 0!==this.secondConnection},t.prototype.dispatchConnected=function(){if(void 0!==this.firstConnection){var t=this.firstConnection.getServerState(),e=t.url.endsWith("/")?t.url.slice(0,-1):t.url,n={baseEndpointUrl:e,newEndpointUrl:e!==this.baseEndpointUrl,c2cUrlBase:t.c2cUrlBase,clientId:t.connectedClientId,connectionId:t.connectionId,connectionTtlSec:t.getRemainingTtlInSec()};this.baseEndpointUrl=e,this.listener.onTrouterConnected(t.url,n);}},t.prototype.dispatchDisconnected=function(){this.listener.onTrouterDisconnected&&this.listener.onTrouterDisconnected();},t.prototype.dispatchTerminalError=function(){this.listener.onTrouterDisconnected&&this.listener.onTrouterDisconnected();},t.prototype.dispatchRegistrationState=function(t){this.options.registrationStateCallback&&this.options.registrationStateCallback(t);},t.prototype.expediteBackoffOnConnections=function(){var t;if(void 0!==this.lastExpediteBackoffCallAt&&Date.now()-this.lastExpediteBackoffCallAt<(null!==(t=this.options.expediteBackoffOnStartMinimumDelayMs)&&void 0!==t?t:1e4))return void this.logger.info("Expedite backoff due to start() too frequent, skipping");this.lastExpediteBackoffCallAt=Date.now(),void 0!==this.firstConnection&&this.firstConnection.expediteBackoff(),void 0!==this.secondConnection&&this.secondConnection.expediteBackoff();},t.prototype.onDownstreamRequest=function(t,e,n){var o={id:e.id,method:e.method,path:"/".concat(e.shortUrl),body:e.body,headers:e.headers},i={id:e.id,status:0,headers:{},body:"",send:function(){return i.status<=100||i.status>=999?3:(n.writeHead(i.status,i.headers),n.end(i.body))}};this.listener.onTrouterRequest(o,i);},t.prototype.onConnected=function(t){this.fsm.onConnected(t===this.firstConnection);},t.prototype.onRegistered=function(t){this.fsm.onRegistered(t===this.firstConnection);},t.prototype.onUnregistered=function(t){this.fsm.onUnregistered(t===this.firstConnection||t===this.storedFirstConnection);},t.prototype.onReconnecting=function(t){this.fsm.onReconnecting(t===this.firstConnection);},t.prototype.onReconnectIsRequired=function(t,e,n){this.fsm.onReconnectionRequired(t===this.firstConnection,e,n);},t.prototype.onDisconnected=function(t){this.fsm.onDisconnected(t===this.firstConnection||t==this.storedFirstConnection),this.storedFirstConnection=void 0;},t.prototype.onTerminalError=function(){this.fsm.onTerminalError(),this.storedFirstConnection=void 0;},t.prototype.onUserActivityStateAccepted=function(t){this.listener.onTrouterUserActivityStateAccepted&&this.listener.onTrouterUserActivityStateAccepted(t);},t.prototype.onAudiencesSetResolved=function(t,e){var n,o;null===(o=(n=this.listener).onAudiencesSetResolved)||void 0===o||o.call(n,t,e);},t.prototype.onConnectionParametersUpdated=function(t){this.setConnectionCache(t);},t.prototype.setUserActivityState=function(t,e){return this.userActivityObject=new g(t,r.CorrelationVector.extend(e)),void 0!==this.secondConnection?(this.logger.info("Setting user activity ".concat(this.userActivityObject.toEventJSON()," on the second/new connection")),void this.secondConnection.setUserActivityState(this.userActivityObject)):void 0!==this.firstConnection?(this.logger.info("Setting user activity ".concat(this.userActivityObject.toEventJSON()," on the first/current connection")),void this.firstConnection.setUserActivityState(this.userActivityObject)):void 0},t.prototype.setAudienceSubscriptionsAsync=function(t,e,n){if(this.audienceSubscriptionState=new f(t,r.CorrelationVector.extend(n)),this.secondConnection)return this.logger.info("Setting audience subscriptions ".concat(this.audienceSubscriptionState.toEventJSON()," on second/new connection")),this.secondConnection.setAudienceSubscriptionsAsync(this.audienceSubscriptionState,e);if(this.firstConnection)return this.logger.info("Setting audience subscriptions ".concat(this.audienceSubscriptionState.toEventJSON()," on first/current connection")),this.firstConnection.setAudienceSubscriptionsAsync(this.audienceSubscriptionState,e);throw new Error("No connection found")},t.prototype.onTrouterMessageLost=function(t){var e=this;if(this.listener.onTrouterMessageLoss)if(null===t||void 0===t?void 0:t.length){var n=t.filter(function(t){return void 0!==e.processedMessageLoss["".concat(t.tag,"-").concat(t.etag)]});if(n.length&&(this.logger.info("onTrouterMessageLoss - immediately acknowledging ".concat(n.length," seen dropped indicators")),this.sendProcessedDroppedIndicators(n),t=t.filter(function(t){return void 0===e.processedMessageLoss["".concat(t.tag,"-").concat(t.etag)]}),!t.length))return void this.logger.info("onTrouterMessageLoss - all declared dropped indicators have been seen before");var o=this.listener.onTrouterMessageLoss(t.map(function(t){return t.tag}));if(!o)return void this.logger.warn("onTrouterMessageLoss - some flow tag(s) have not been processed by listeners");t.forEach(function(t){e.processedMessageLoss["".concat(t.tag,"-").concat(t.etag)]="";}),this.sendProcessedDroppedIndicators(t);}else this.logger.warn("onTrouterMessageLoss - no flow tags have been provided");},t.prototype.getConnectionCache=function(){var t=this;return this.options.connectionCache?(this.logger.debug("Querying host's connection cache"),this.options.connectionCache.onGetTrouterConnectionCache().then(function(t){var e=t?JSON.parse(t):void 0;return "object"==typeof e?e:void 0}).catch(function(e){return t.logger.warn("Invalid connection cache content provided: ".concat(e)),t.connectionCache})):Promise.resolve(this.connectionCache)},t.prototype.setConnectionCache=function(t){if(this.connectionCache=t,this.options.connectionCache)try{this.options.connectionCache.onSetTrouterConnectionCache(JSON.stringify(t));}catch(t){this.logger.warn("Error setting external connection cache: ".concat(t));}},t.prototype.sendProcessedDroppedIndicators=function(t){return void 0!==this.firstConnection?void this.firstConnection.sendProcessedDroppedIndicators(t):void 0!==this.secondConnection?void this.secondConnection.sendProcessedDroppedIndicators(t):void 0},t.prototype.configuredTrouterManager=function(){return new h.RegistrationEnforcer(this,this.options.connectionDependsOnRegistration,this.options.delayEventsUntilRegistered)},t}();e.TrouterManager=v;},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.TrouterUrlPromise=void 0;var o=n(0),i=function(){function t(t){this.logger=new o.Logger("UrlPromise",t);}return t.prototype.getPromise=function(){var t=this;return void 0!==this.url?(this.logger.debug("returning previously resolved url: ".concat(this.url)),Promise.resolve(this.url)):(void 0===this.pendingPromise?(this.logger.debug("creating and returning promise"),this.pendingPromise=new Promise(function(e,n){t.pendingPromiseResolveRef=e,t.pendingPromiseRejectRef=n;})):this.logger.debug("returning existing promise"),this.pendingPromise)},t.prototype.resolveUrl=function(t){this.url=t,this.logger.debug("got url: ".concat(this.url));var e=this.pendingPromiseResolveRef;this.pendingPromise=void 0,this.pendingPromiseResolveRef=void 0,this.pendingPromiseRejectRef=void 0,void 0!==e&&(this.logger.debug("resolving promise"),e(t));},t.prototype.rejectUrl=function(t){this.logger.debug("aborting");var e=this.pendingPromiseRejectRef;this.url=void 0,this.pendingPromise=void 0,this.pendingPromiseResolveRef=void 0,this.pendingPromiseRejectRef=void 0,void 0!==e&&(this.logger.debug("rejecting promise"),e(t));},t.prototype.resetUrl=function(){this.logger.debug("resetting url"),this.url=void 0;},t}();e.TrouterUrlPromise=i;},function(t,e,n){(function(t,n){!function(t,e){var n=t;n.version="0.9.6",n.protocol=1,n.transports=[],n.j=[],n.sockets={},n.connect=function(t,o){var i,r,s=n.util.parseUri(t);e&&e.location&&(s.protocol=s.protocol||e.location.protocol.slice(0,-1),s.host=s.host||(e.document?e.document.domain:e.location.hostname),s.port=s.port||e.location.port),i=n.util.uniqueUri(s);var c={host:s.host,secure:"https"==s.protocol,port:s.port||("https"==s.protocol?443:80),query:s.query||""};return n.util.merge(c,o),!c["force new connection"]&&n.sockets[i]||(r=new n.Socket(c)),!c["force new connection"]&&r&&(n.sockets[i]=r),r=r||n.sockets[i],c["skipped handshake data"]?r.of(""):r.of(s.path.length>1?s.path:"")};}(n.exports,void 0===t?window:t);var o=n.exports;!function(t,e){var n=t.util={},o=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,i=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];n.parseUri=function(t){for(var e=o.exec(t||""),n={},r=14;r--;)n[i[r]]=e[r]||"";return n},n.uniqueUri=function(t){var n=t.protocol,o=t.host,i=t.port;return "document"in e?(o=o||document.domain,i=i||("https"==n&&"https:"!==document.location.protocol?443:document.location.port)):(o=o||"localhost",i||"https"!=n||(i=443)),(n||"http")+"://"+o+":"+(i||80)},n.query=function(t,e){var o=n.chunkQuery(t||""),i=[];n.merge(o,n.chunkQuery(e||""));for(var r in o)o.hasOwnProperty(r)&&i.push(r+"="+o[r]);return i.length?"?"+i.join("&"):""},n.chunkQuery=function(t){for(var e,n={},o=t.split("&"),i=0,r=o.length;i<r;++i)e=o[i].split("="),e[0]&&(n[e[0]]=e[1]);return n};var r=!1;n.load=function(t){if("document"in e&&"complete"===document.readyState||r)return t();n.on(e,"load",t,!1);},n.on=function(t,e,n,o){t.attachEvent?t.attachEvent("on"+e,n):t.addEventListener&&t.addEventListener(e,n,o);},n.request=function(t){if(t&&"undefined"!=typeof XDomainRequest)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!t||n.ua.hasCORS))return new XMLHttpRequest;if(!t)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(t){}return null},"undefined"!=typeof window&&n.load(function(){r=!0;}),n.defer=function(t){if(!n.ua.webkit||"undefined"!=typeof importScripts)return t();n.load(function(){setTimeout(t,100);});},n.merge=function(t,e,o,i){var r,s=i||[],c=void 0===o?2:o;for(r in e)e.hasOwnProperty(r)&&n.indexOf(s,r)<0&&("object"==typeof t[r]&&c?n.merge(t[r],e[r],c-1,s):(t[r]=e[r],s.push(e[r])));return t},n.mixin=function(t,e){n.merge(t.prototype,e.prototype);},n.inherit=function(t,e){function n(){}n.prototype=e.prototype,t.prototype=new n;},n.isArray=Array.isArray||function(t){return "[object Array]"===Object.prototype.toString.call(t)},n.intersect=function(t,e){for(var o=[],i=t.length>e.length?t:e,r=t.length>e.length?e:t,s=0,c=r.length;s<c;s++)~n.indexOf(i,r[s])&&o.push(r[s]);return o},n.indexOf=function(t,e,n){for(var o=t.length,n=n<0?n+o<0?0:n+o:n||0;n<o&&t[n]!==e;n++);return o<=n?-1:n},n.toArray=function(t){for(var e=[],n=0,o=t.length;n<o;n++)e.push(t[n]);return e},n.ua={},n.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var t=new XMLHttpRequest;}catch(t){return !1}return void 0!=t.withCredentials}(),n.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent);}(void 0!==o?o:n.exports,void 0===t?window:t),function(t,e){function n(){}t.EventEmitter=n,n.prototype.on=function(t,n){return this.$events||(this.$events={}),this.$events[t]?e.util.isArray(this.$events[t])?this.$events[t].push(n):this.$events[t]=[this.$events[t],n]:this.$events[t]=n,this},n.prototype.addListener=n.prototype.on,n.prototype.once=function(t,e){function n(){o.removeListener(t,n),e.apply(this,arguments);}var o=this;return n.listener=e,this.on(t,n),this},n.prototype.removeListener=function(t,n){if(this.$events&&this.$events[t]){var o=this.$events[t];if(e.util.isArray(o)){for(var i=-1,r=0,s=o.length;r<s;r++)if(o[r]===n||o[r].listener&&o[r].listener===n){i=r;break}if(i<0)return this;o.splice(i,1),o.length||delete this.$events[t];}else (o===n||o.listener&&o.listener===n)&&delete this.$events[t];}return this},n.prototype.removeAllListeners=function(t){return this.$events&&this.$events[t]&&(this.$events[t]=null),this},n.prototype.listeners=function(t){return this.$events||(this.$events={}),this.$events[t]||(this.$events[t]=[]),e.util.isArray(this.$events[t])||(this.$events[t]=[this.$events[t]]),this.$events[t]},n.prototype.emit=function(t){if(!this.$events)return !1;var n=this.$events[t];if(!n)return !1;var o=Array.prototype.slice.call(arguments,1);if("function"==typeof n)n.apply(this,o);else {if(!e.util.isArray(n))return !1;for(var i=n.slice(),r=0,s=i.length;r<s;r++)i[r].apply(this,o);}return !0};}(void 0!==o?o:n.exports,void 0!==o?o:n.parent.exports),function(t,e){if(e&&e.parse)return t.JSON={parse:e.parse,stringify:e.stringify};throw new Error("JSON not available")}(void 0!==o?o:n.exports,"undefined"!=typeof JSON?JSON:void 0),function(t,e){var n=t.parser={},o=n.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],i=n.reasons=["transport not supported","client not handshaken","unauthorized"],r=n.advice=["reconnect"],s=e.JSON,c=e.util.indexOf;n.encodePacket=function(t){var e=c(o,t.type),n=t.id||"",a=t.endpoint||"",u=t.ack,h=null;switch(t.type){case"error":var d=t.reason?c(i,t.reason):"",l=t.advice?c(r,t.advice):"";""===d&&""===l||(h=d+(""!==l?"+"+l:""));break;case"message":""!==t.data&&(h=t.data);break;case"event":var p={name:t.name};t.args&&t.args.length&&(p.args=t.args),h=s.stringify(p);break;case"json":h=s.stringify(t.data);break;case"connect":t.qs&&(h=t.qs);break;case"ack":h=t.ackId+(t.args&&t.args.length?"+"+s.stringify(t.args):"");}var g=[e,n+("data"==u?"+":""),a];return null!==h&&void 0!==h&&g.push(h),g.join(":")},n.encodePayload=function(t){var e="";if(1==t.length)return t[0];for(var n=0,o=t.length;n<o;n++){e+="�"+t[n].length+"�"+t[n];}return e};var a=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;n.decodePacket=function(t){var e=t.match(a);if(!e)return {};var n=e[2]||"",t=e[5]||"",c={type:o[e[1]],endpoint:e[4]||""};switch(n&&(c.id=n,e[3]?c.ack="data":c.ack=!0),c.type){case"error":var e=t.split("+");c.reason=i[e[0]]||"",c.advice=r[e[1]]||"";break;case"message":c.data=t||"";break;case"event":try{var u=s.parse(t);c.name=u.name,c.args=u.args;}catch(t){}c.args=c.args||[];break;case"json":try{c.data=s.parse(t);}catch(t){}break;case"connect":c.qs=t||"";break;case"ack":var e=t.match(/^([0-9]+)(\+)?(.*)/);if(e&&(c.ackId=e[1],c.args=[],e[3]))try{c.args=e[3]?s.parse(e[3]):[];}catch(t){}break;case"disconnect":c.reason=t;}return c},n.decodePayload=function(t){if("�"==t.charAt(0)){for(var e=[],o=1,i="";o<t.length;o++)"�"==t.charAt(o)?(e.push(n.decodePacket(t.substr(o+1).substr(0,i))),o+=Number(i)+1,i=""):i+=t.charAt(o);return e}return [n.decodePacket(t)]};}(void 0!==o?o:n.exports,void 0!==o?o:n.parent.exports),function(t,e){function n(t,e){this.socket=t,this.sessid=e,this.connectErrorCallback=void 0,this.isOpened=!1;}t.Transport=n,e.util.mixin(n,e.EventEmitter),n.prototype.onData=function(t){if(this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout(),""!==t){var n=e.parser.decodePayload(t);if(n&&n.length)for(var o=0,i=n.length;o<i;o++)this.onPacket(n[o]);}return this},n.prototype.onPacket=function(t){return this.socket.setHeartbeatTimeout(),"heartbeat"==t.type?this.onHeartbeat():("connect"==t.type&&""==t.endpoint&&this.onConnect(),"error"==t.type&&"reconnect"==t.advice&&(this.isOpened=!1),this.socket.onPacket(t),this)},n.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var t=this;this.closeTimeout=setTimeout(function(){t.onDisconnect();},this.socket.closeTimeout);}},n.prototype.onDisconnect=function(){return this.close&&this.isOpened&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},n.prototype.onConnect=function(){return this.socket.onConnect(),this.connectErrorCallback=void 0,this},n.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null);},n.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout);},n.prototype.packet=function(t){this.send(e.parser.encodePacket(t));},n.prototype.onHeartbeat=function(t){this.packet({type:"heartbeat"});},n.prototype.onOpen=function(){this.isOpened=!0,this.clearCloseTimeout(),this.socket.onOpen();},n.prototype.onClose=function(){this.isOpened=!1,this.socket.onClose(),this.onDisconnect();},n.prototype.prepareUrl=function(t){var n=this.socket.options;if(n["skipped handshake data"])return n.rewriteUrlForProxy(n["skipped handshake data"].websocketUrl+(t||""));var o=this.scheme()+"://"+n.host+":"+n.port+"/"+n.resource+"/"+e.protocol+"/"+this.name+"/"+this.sessid+(t||"");return n.rewriteUrlForProxy(o)},n.prototype.ready=function(t,e){e.call(this);},n.prototype.clearEventHandlers=function(){return this};}(void 0!==o?o:n.exports,void 0!==o?o:n.parent.exports),function(t,e,n){function o(t){if(this.options={port:80,secure:!1,document:"document"in n&&document,resource:"socket.io",transports:e.transports.slice(),"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":1/0,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!0,"auto connect":!0,"flash policy port":10843},e.util.merge(this.options,t),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1,this.disconnected=!1,this.options["sync disconnect on unload"]&&(!this.isXDomain()||e.util.ua.hasCORS)){var o=this;e.util.on(n,"unload",function(){o.disconnectSync();},!1);}this.options["auto connect"]&&this.connect();}function i(){}t.Socket=o,e.util.mixin(o,e.EventEmitter),o.prototype.of=function(t){return this.namespaces[t]||(this.namespaces[t]=new e.SocketNamespace(this,t),""!==t&&this.namespaces[t].packet({type:"connect"})),this.namespaces[t]},o.prototype.publish=function(){this.emit.apply(this,arguments);var t;for(var e in this.namespaces)this.namespaces.hasOwnProperty(e)&&(t=this.of(e),t.$emit.apply(t,arguments));},o.prototype.handshake=function(t){function n(e){e instanceof Error?o.onError(e.message):t.apply(null,e.split(":"));}var o=this,r=this.options;if(!o.disconnected){var s=r.rewriteUrlForProxy(["http"+(r.secure?"s":"")+":/",r.host+":"+r.port,r.resource,e.protocol,e.util.query(this.options.query,"t="+ +new Date)].join("/"));if(this.isXDomain()&&!e.util.ua.hasCORS){var c=document.getElementsByTagName("script")[0],a=document.createElement("script");a.src=s+"&jsonp="+e.j.length,c.parentNode.insertBefore(a,c),e.j.push(function(t){n(t),a.parentNode.removeChild(a);});}else {var u=e.util.request();u.open("GET",s,!0);var h=this.options.requestHeaders;void 0!==h&&Object.keys(h).forEach(function(t){u.setRequestHeader(t,h[t]);}),u.onreadystatechange=function(){4==u.readyState&&(u.onreadystatechange=i,200==u.status?n(u.responseText):!o.reconnecting&&o.onError(u.responseText));},u.send(null);}}},o.prototype.getTransport=function(t){for(var n,o=t||this.transports,i=0;n=o[i];i++)if(e.Transport[n]&&e.Transport[n].check(this)&&(!this.isXDomain()||e.Transport[n].xdomainCheck()))return new e.Transport[n](this,this.sessionid);return null},o.prototype.connect=function(t){if(this.connecting||this.disconnected)return this;var n=this,o=function(o,i,r,s){function c(){if(!n.connected&&!n.disconnected)if(n.connecting=!1,clearTimeout(n.connectTimeoutTimer),n.options["try multiple transports"]){for(;n.remainingTransports.length>0&&n.remainingTransports.splice(0,1)[0]!=n.transport.name;);n.remainingTransports.length?a(n.remainingTransports):n.publish("connect_failed");}else n.publish("connect_failed");}function a(t){if(n.transport&&(n.transport.clearTimeouts(),n.transport.clearEventHandlers()),n.transport=n.getTransport(t),!n.transport||n.disconnected)return n.publish("connect_failed");n.transport.ready(n,function(){n.connecting=!0,n.publish("connecting",n.transport.name),n.transport.open(c),n.options["connect timeout"]&&(n.connectTimeoutTimer=setTimeout(function(){c();},n.options["connect timeout"]));});}n.sessionid=o,n.closeTimeout=1e3*r+2e3,n.heartbeatTimeout=1e3*i+2e3,n.transports=s?e.util.intersect(s.split(","),n.options.transports):n.options.transports,n.setHeartbeatTimeout(),n.remainingTransports=n.transports.slice(0),a(n.transports),n.once("connect",function(){clearTimeout(n.connectTimeoutTimer),t&&"function"==typeof t&&t();});};if(this.options["skipped handshake data"]){var i=this.options["skipped handshake data"];o("v4c-"+(new Date).getTime(),i.timeout,i.timeout,"websocket");}else this.handshake(o);return this},o.prototype.setHeartbeatTimeout=function(){clearTimeout(this.heartbeatTimeoutTimer);var t=this;this.heartbeatTimeoutTimer=setTimeout(function(){t.transport.onClose();},this.heartbeatTimeout);},o.prototype.packet=function(t){return this.connected&&!this.doBuffer?this.transport.packet(t):this.buffer.push(t),this},o.prototype.setBuffer=function(t){this.doBuffer=t,!t&&this.connected&&this.buffer.length&&(this.transport.payload(this.buffer),this.buffer=[]);},o.prototype.disconnect=function(){return (this.connected||this.connecting)&&(this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted")),this.disconnected=!0,this},o.prototype.disconnectSync=function(){var t=e.util.request(),n=this.resource+"/"+e.protocol+"/"+this.sessionid;t.open("GET",n,!0),this.onDisconnect("booted");},o.prototype.isXDomain=function(){var t=n.location.port||("https:"==n.location.protocol?443:80);return this.options.host!==n.location.hostname||this.options.port!=t},o.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"));},o.prototype.onOpen=function(){this.open=!0;},o.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer);},o.prototype.onPacket=function(t){this.of(t.endpoint).onPacket(t);},o.prototype.onError=function(t){t&&t.advice&&"reconnect"===t.advice&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",t&&t.reason?t.reason:t);},o.prototype.onDisconnect=function(t){var e=this.connected,n=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1,(e||n)&&(this.transport.close(),this.transport.clearTimeouts(),e?(this.publish("disconnect",t),"booted"!=t&&this.options.reconnect&&!this.reconnecting&&this.reconnect()):this.publish("close_during_connecting",t));},o.prototype.reconnect=function(){function t(){if(n.connected){for(var t in n.namespaces)n.namespaces.hasOwnProperty(t)&&""!==t&&n.namespaces[t].packet({type:"connect"});n.publish("reconnect",n.transport.name,n.reconnectionAttempts);}clearTimeout(n.reconnectionTimer),n.removeListener("connect_failed",e),n.removeListener("connect",e),n.reconnecting=!1,delete n.reconnectionAttempts,delete n.reconnectionDelay,delete n.reconnectionTimer,delete n.redoTransports,n.options["try multiple transports"]=i;}function e(){if(n.reconnecting)return n.connected?t():n.connecting&&n.reconnecting?n.reconnectionTimer=setTimeout(e,1e3):void(n.reconnectionAttempts++>=o?n.redoTransports?(n.publish("reconnect_failed"),t()):(n.on("connect_failed",e),n.options["try multiple transports"]=!0,n.transport=n.getTransport(),n.redoTransports=!0,n.connect()):(n.reconnectionDelay<r&&(n.reconnectionDelay*=2),n.connect(),n.publish("reconnecting",n.reconnectionDelay,n.reconnectionAttempts),n.reconnectionTimer=setTimeout(e,n.reconnectionDelay)))}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var n=this,o=this.options["max reconnection attempts"],i=this.options["try multiple transports"],r=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(e,this.reconnectionDelay),this.on("connect",e);};}(void 0!==o?o:n.exports,void 0!==o?o:n.parent.exports,void 0===t?window:t),function(t,e){function n(t,e){this.socket=t,this.name=e||"",this.flags={},this.json=new o(this,"json"),this.ackPackets=0,this.acks={};}function o(t,e){this.namespace=t,this.name=e;}t.SocketNamespace=n,e.util.mixin(n,e.EventEmitter),n.prototype.$emit=e.EventEmitter.prototype.emit,n.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},n.prototype.packet=function(t){return t.endpoint=this.name,this.socket.packet(t),this.flags={},this},n.prototype.send=function(t,e){var n={type:this.flags.json?"json":"message",data:t};return "function"==typeof e&&(n.id=++this.ackPackets,n.ack=!0,this.acks[n.id]=e),this.packet(n)},n.prototype.emit=function(t){var e=Array.prototype.slice.call(arguments,1),n=e[e.length-1],o={type:"event",name:t};return "function"==typeof n&&(o.id=++this.ackPackets,o.ack="data",this.acks[o.id]=n,e=e.slice(0,e.length-1)),o.args=e,this.packet(o)},n.prototype.disconnect=function(){return ""===this.name?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},n.prototype.onPacket=function(t){function n(){o.packet({type:"ack",args:e.util.toArray(arguments),ackId:t.id});}var o=this;switch(t.type){case"connect":this.$emit("connect");break;case"disconnect":""===this.name?this.socket.onDisconnect(t.reason||"booted"):this.$emit("disconnect",t.reason||"");break;case"message":case"json":var i=["message",t.data];"data"==t.ack?i.push(n):t.ack&&this.packet({type:"ack",ackId:t.id}),this.$emit.apply(this,i);break;case"event":var i=[t.name].concat(t.args);"data"==t.ack&&i.push(n),this.$emit.apply(this,i);break;case"ack":this.acks[t.ackId]&&(this.acks[t.ackId].apply(this,t.args),delete this.acks[t.ackId]);break;case"error":t.advice?this.socket.onError(t):"unauthorized"==t.reason?this.$emit("connect_failed",t.reason):this.$emit("error",t.reason);}},o.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments);},o.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments);};}(void 0!==o?o:n.exports,void 0!==o?o:n.parent.exports),function(t,e,n){function o(t){e.Transport.apply(this,arguments);}function i(){}t.websocket=o,e.util.inherit(o,e.Transport),o.prototype.name="websocket",o.prototype.open=function(t){var o,i=e.util.query(this.socket.options.query),r=this;return this.connectErrorCallback=t,o||(o=n.MozWebSocket||n.WebSocket),this.websocket=new o(this.prepareUrl(i)),this.websocket.onopen=function(){r.onOpen(),r.socket.setBuffer(!1);},this.websocket.onmessage=function(t){r.onData(t.data);},this.websocket.onclose=function(){r.onClose(),r.socket.setBuffer(!0);},this.websocket.onerror=function(t){r.onError(t);},this},o.prototype.send=function(t){return this.websocket.send(t),this},o.prototype.payload=function(t){for(var e=0,n=t.length;e<n;e++)this.packet(t[e]);return this},o.prototype.close=function(){return this.websocket.close(),this},o.prototype.onError=function(t){void 0!==this.connectErrorCallback&&(this.connectErrorCallback(),this.connectErrorCallback=void 0),this.socket.onError(t);},o.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},o.check=function(){return "WebSocket"in n&&!("__addTask"in WebSocket)||"MozWebSocket"in n},o.xdomainCheck=function(){return !0},o.prototype.clearEventHandlers=function(){return this.websocket&&(this.websocket.onopen=this.websocket.onmessage=this.websocket.onclose=this.websocket.onerror=i),this},e.transports.push("websocket");}(void 0!==o?o.Transport:n.exports,void 0!==o?o:n.parent.exports,void 0===t?window:t),function(t,e,n){function o(t){t&&e.Transport.apply(this,arguments);}function i(){}t.XHR=o,e.util.inherit(o,e.Transport),o.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},o.prototype.payload=function(t){for(var n=[],o=0,i=t.length;o<i;o++)n.push(e.parser.encodePacket(t[o]));this.send(e.parser.encodePayload(n));},o.prototype.send=function(t){return this.post(t),this},o.prototype.post=function(t){function e(){4==this.readyState&&(this.onreadystatechange=i,200==this.status?(clearTimeout(this.ackTimeoutTimer),r.socket.setBuffer(!1)):r.onClose());}function o(){this.onload=i,r.socket.setBuffer(!1);}var r=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),n.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=o:this.sendXHR.onreadystatechange=e,this.sendXHR.send(t),r.sendXHR.ackTimeoutTimer=setTimeout(function(){r.onClose();},r.socket.options.ackTimeoutMs);},o.prototype.close=function(){return this.onClose(),this},o.prototype.request=function(t){var n=e.util.request(this.socket.isXDomain()),o=e.util.query(this.socket.options.query,"t="+ +new Date);n.open(t||"GET",this.prepareUrl(o),!0);var i=this.socket.options.requestHeaders;if(void 0!==i&&Object.keys(i).forEach(function(t){n.setRequestHeader(t,i[t]);}),"POST"==t)try{n.setRequestHeader?n.setRequestHeader("Content-type","text/plain;charset=UTF-8"):n.contentType="text/plain";}catch(t){}return n},o.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},o.check=function(t,o){try{var i=e.util.request(o),r=n.XDomainRequest&&i instanceof XDomainRequest,s=t&&t.options&&t.options.secure?"https:":"http:",c=s!=n.location.protocol;if(i&&(!r||!c))return !0}catch(t){}return !1},o.xdomainCheck=function(){return o.check(null,!0)},o.prototype.clearEventHandlers=function(){return this.sendXHR&&(this.sendXHR.onreadystatechange=this.sendXHR.onload=i),this};}(void 0!==o?o.Transport:n.exports,void 0!==o?o:n.parent.exports,void 0===t?window:t),function(t,e,n){function o(){e.Transport.XHR.apply(this,arguments);}function i(){}t["xhr-polling"]=o,e.util.inherit(o,e.Transport.XHR),e.util.merge(o,e.Transport.XHR),o.prototype.name="xhr-polling",o.prototype.open=function(t){var n=this;return n.connectErrorCallback=t,e.Transport.XHR.prototype.open.call(n),!1},o.prototype.get=function(){function t(){4==this.readyState&&(this.onreadystatechange=i,200==this.status?(r.connectErrorCallback=void 0,r.onData(this.responseText),r.get()):(r.onClose(),void 0!==r.connectErrorCallback&&(r.connectErrorCallback(),r.connectErrorCallback=void 0)));}function e(){r.connectErrorCallback=void 0,this.onload=i,this.onerror=i,r.onData(this.responseText),r.get();}function o(){r.onClose(),void 0!==r.connectErrorCallback&&(r.connectErrorCallback(),r.connectErrorCallback=void 0);}if(this.isOpened){var r=this;this.xhr=this.request(),n.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=e,this.xhr.onerror=o):this.xhr.onreadystatechange=t,this.xhr.send(null);}},o.prototype.onClose=function(){if(e.Transport.XHR.prototype.onClose.call(this),this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=i;try{this.xhr.abort();}catch(t){}this.xhr=null;}},o.prototype.ready=function(t,n){var o=this;e.util.defer(function(){n.call(o);});},o.prototype.clearEventHandlers=function(){return e.Transport.XHR.prototype.clearEventHandlers.call(this),this.xhr&&(this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=i),this},e.transports.push("xhr-polling");}(void 0!==o?o.Transport:n.exports,void 0!==o?o:n.parent.exports,void 0===t?window:t),e.io=o;}).call(e,n(13),n(14)(t));},function(t,e){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this");}catch(t){"object"==typeof window&&(n=window);}t.exports=n;},function(t,e){t.exports=function(t){return t.webpackPolyfill||(t.deprecate=function(){},t.paths=[],t.children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),t.webpackPolyfill=1),t};},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.ConnectionTracker=e.Properties=e.TrackerStep=e.ClientEventName=e.ResponseData=void 0;var o=n(3),i=n(1),r=n(0),s=function(){function t(t){this.id=t,this.status=200,this.headers={},this.body="";}return t}();e.ResponseData=s;var c;!function(t){t.Connected="trouter_js_client_connected",t.Disconnected="trouter_js_client_disconnected",t.Error="trouter_js_client_error",t.Progress="trouter_js_client_progress",t.Response="trouter_js_client_response",t.Request="trouter_js_client_request",t.CheckConnection="trouter_js_client_check_connection",t.Registration="trouter_js_client_registration",t.Unregistration="trouter_js_client_unregistration";}(c||(e.ClientEventName=c={}));var a=function(){function t(t,e,n,o,i){this.stepName=t,this.operation=e,this.delta=n,this.ts=o,this.error=i;}return t}();e.TrackerStep=a;var u=function(){function t(){}return t}();e.Properties=u;var h=function(){function t(){this.numberOfPingReplies=0,this.connectedTimestamp=0,this.isNewUrl=!1,this.transportType="",this.connectionNumber=0;}return t}(),d=function(){function t(){this.enabled=!1,this.numberOfStepsToMaintain=40,this.logHealthCheckError=!1,this.sendProgressTimeoutSecs=55,this.logSendPingError=!1,this.maxBackoffInMs=12e4,this.trouter_js_client_connected=!1,this.trouter_js_client_disconnected=!1,this.trouter_js_client_error=!1,this.trouter_js_client_progress=!1,this.trouter_js_client_response=!1,this.trouter_js_client_request=!1,this.trouter_js_client_registration=!1,this.trouter_js_client_unregistration=!1,this.trouter_js_client_check_connection=!0;}return t}(),l=function(){function t(t,e,n,i,s,c,a){this.clientId=e,this.clientInfo=n,this.getServerState=i,this.endpointId=s,this.clientCorrelationID=c,this.environment=a,this.logger=new r.Logger("ConnectionTracker",t),this.clientCorrelationID=void 0!==c?c:"",this.steps=[],this.connectionAttempt=0,this.totalStepCount=0,this.beginTimestamp=new o.Timespan,this.eventLogSettings=new d,this.connectedInfo=new h;}return t.prototype.enable=function(t){this.eventLogSettings.enabled=!0,this.eventLogger=t;},t.prototype.disable=function(){this.eventLogSettings.enabled=!1;},t.prototype.sendProgress=function(t){this.steps.length>0&&this.sendTelemetry(c.Progress,t,this.steps);},t.prototype.cancelProgressTimer=function(){void 0!==this.progressTimeout&&(clearTimeout(this.progressTimeout),this.progressTimeout=void 0);},t.prototype.resetProgressSendTimer=function(){var t=this;this.cancelProgressTimer(),void 0!==this.eventLogSettings.sendProgressTimeoutSecs&&this.eventLogSettings.sendProgressTimeoutSecs>0&&(this.progressTimeout=setTimeout(function(){t.sendProgress({reason:"timeout",timeoutSecs:t.eventLogSettings.sendProgressTimeoutSecs});},1e3*this.eventLogSettings.sendProgressTimeoutSecs));},t.prototype.setConnectedInfo=function(t,e){this.connectedInfo.numberOfPingReplies=0,this.connectedInfo.connectedTimestamp=Date.now(),this.connectedInfo.isNewUrl=t,this.connectedInfo.transportType=e,++this.connectedInfo.connectionNumber;},t.prototype.clearConnectedInfo=function(){this.connectedInfo.numberOfPingReplies=0,this.connectedInfo.connectedTimestamp=0,this.connectedInfo.isNewUrl=!0,this.connectedInfo.transportType="";},t.prototype.copyProperties=function(t,e){for(var n=0,o=Object.keys(e);n<o.length;n++){var i=o[n];void 0!==e[i]&&(t[i.replace(/-/g,"_")]={value:e[i]});}},t.prototype.increasePingResponseCount=function(){++this.connectedInfo.numberOfPingReplies;},t.prototype.sendTelemetry=function(t,e,n){try{if(!0===this.eventLogSettings.enabled&&!0===this.eventLogSettings[t]&&void 0!==this.eventLogger){var r=this.getServerState(),s={name:t,properties:{connectionAttempt:{value:this.connectionAttempt},epid:{value:this.endpointId},clientCorrelationID:{value:this.clientCorrelationID},steps:{value:(0,o.toJson)(n)},clientID:{value:this.clientId},eventVersion:{value:3},environment:{value:this.environment},cv:{value:i.CLIENT_VERSION},ua:{value:this.clientInfo.ua},connectionId:{value:r.connectionId},connectedClientId:{value:r.connectedClientId},domId:{value:r.domId},url:{value:r.unsecureUrl},surl:{value:r.url},ttlInSecs:{value:r.getRemainingTtlInSec()},numberOfPingReplies:{value:this.connectedInfo.numberOfPingReplies},connectedTimestamp:{value:this.connectedInfo.connectedTimestamp},isNewUrl:{value:this.connectedInfo.isNewUrl},transportType:{value:this.connectedInfo.transportType},connectionNumber:{value:this.connectedInfo.connectionNumber}}};this.copyProperties(s.properties,e),this.eventLogger.logEvent(s);}}catch(e){this.logger.warn("error in sending event ".concat(t,": ").concat((0, o.toJson)(e)));}},t.prototype.createStep=function(t,e,n){return new a(t,e,this.beginTimestamp.duration,Date.now(),n)},t.prototype.addStep=function(t,e,n){if(!1!==this.eventLogSettings.enabled&&(0===this.steps.length&&this.beginTimestamp.reset(),this.steps.push(this.createStep(t,e,n)),++this.totalStepCount,void 0!==this.eventLogSettings.numberOfStepsToMaintain&&this.steps.length>this.eventLogSettings.numberOfStepsToMaintain)){var o=this.steps.slice(0);this.steps.length=0,this.sendTelemetry(c.Progress,{reason:"flush"},o);}},t.prototype.trackStart=function(t){this.addStep(t,"start");},t.prototype.trackEnd=function(t){this.addStep(t,"end");},t.prototype.trackError=function(t,e,n,o){void 0===n&&(n=!0),"health"===t&&!0!==this.eventLogSettings.logHealthCheckError||"ping"===t&&!1===this.eventLogSettings.logSendPingError||(void 0===o&&(o="error"),!0===n&&this.addStep(t,o,e),this.sendTelemetry(c.Error,{},[this.createStep(t,o,e)]));},t.prototype.trackProgress=function(t,e){this.addStep(t,e);},t.prototype.trackConnected=function(t,e){this.setConnectedInfo(t,e);var n=this.steps.slice(0),o=this.totalStepCount,i=this.beginTimestamp.duration;this.steps.length=0,this.totalStepCount=0,this.sendTelemetry(c.Connected,{stepCount:n.length,totalStepCount:o,connectionEstablishmentMs_Total:i},n),this.cancelProgressTimer();},t.prototype.getSessionLength=function(){return Date.now()-this.connectedInfo.connectedTimestamp},t.prototype.trackDisconnected=function(t){t.sessionLengthMS=this.getSessionLength(),this.sendTelemetry(c.Disconnected,t,[]),this.resetProgressSendTimer();},t.prototype.trackNewConnection=function(){++this.connectionAttempt;},t.prototype.trackRequest=function(t,e){var n={};void 0!==e&&(n.hasError=!0,n.error=e);try{if(t){n.requestID=t.id,n.httpMethod=t.method,n.url=t.url,n.bodyLength=t.body.length,n.shortUrl=t.shortUrl,n.requestTimeStamp=t.startTS,n.correlationVector=t.correlationVector;for(var i=t.headers,r=0,s=Object.keys(i);r<s.length;r++){var a=s[r];n[a]=i[a];}}}catch(t){n.hasError=!0,n.error="".concat(n.error," error creating request context ").concat((0, o.toJson)(t));}this.sendTelemetry(c.Request,n,[]);},t.prototype.trackResponse=function(t,e,n,i){var r={};void 0!==i&&(r.hasError=!0,r.error=i);try{if(r.responseTimestamp=void 0!==n?n.sentTS:Date.now(),t){r.requestID=t.id,r.httpMethod=t.method,r.shortUrl=t.shortUrl,r.correlationVector=t.correlationVector;for(var s=t.headers,a=0,u=Object.keys(s);a<u.length;a++){var h=u[a];r[h]=s[h];}}n&&(r.latencyMS=e,r.responseCode=n.status,r.responseLength=n.body.length);}catch(t){r.hasError=!0,r.error="".concat(r.error," error creating response context ").concat((0, o.toJson)(t));}this.sendTelemetry(c.Response,r,[]);},t.prototype.sendResponseError=function(t,e,n){this.trackResponse(e,void 0,n,t);},t.prototype.close=function(){this.sendProgress({reason:"closed"}),this.steps.length=0,this.cancelProgressTimer();},t.prototype.mergeSettings=function(t){if(t){this.eventLogSettings.numberOfStepsToMaintain=Math.min(40,Math.max(10,void 0!==t.numberOfStepsToMaintain?t.numberOfStepsToMaintain:0));var e=Math.min(3600,Math.max(55,void 0!==t.sendProgressTimeoutSecs?t.sendProgressTimeoutSecs:0));this.eventLogSettings.logHealthCheckError=t.logHealthCheckError,this.eventLogSettings.logSendPingError=t.logSendPingError;for(var n=0,o=Object.keys(c).map(function(t){return c[t]});n<o.length;n++){var i=o[n];void 0!==t[i]&&(this.eventLogSettings[i]=t[i]);}this.eventLogSettings.sendProgressTimeoutSecs!==e&&(this.eventLogSettings.sendProgressTimeoutSecs=e,this.resetProgressSendTimer());}},t}();e.ConnectionTracker=l;},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.DisconnectReason=void 0;var o=function(){function t(t,e,n){this.reason=t,this.claims=e,this.details=n;}return t.fromRawReason=function(e,n){if(""===e||"dup"===e)return new t(e);try{var o=JSON.parse(e);return "object"!=typeof o||void 0===o.reason?(null===n||void 0===n||n.error("invalid disconnect reason format"),new t("unknown",void 0,e)):new t(o.reason,o.claims,o.details)}catch(n){return new t("disconnect",void 0,e)}},t.fromSocketIoEventData=function(e,n){return "string"==typeof n?new t(e,void 0,n):void 0},t.prototype.toTelemetryString=function(){return "socketerror"===this.reason||"reconnecterror"===this.reason||"disconnect"===this.reason?this.details:this.reason},t}();e.DisconnectReason=o;},function(t,e,n){function o(t,e,n){if(void 0===t||void 0===e)return !1;var o=Date.now()-t;return o>e*n.tolerance&&o>n.minimumWaitMs}Object.defineProperty(e,"__esModule",{value:!0}),e.ExponentialBackoff=void 0;var i=function(){function t(t,e,n){void 0===n&&(n={tolerance:2,minimumWaitMs:1e4}),this.logger=t,this.maxBackoffInMs=e,this.gapDetectionSettings=n,this.backoffId=0,this.backoffCount=0;}return t.calculateNextBackoffMs=function(t,e){var n=1+.4*(Math.random()-.5),o=1e3*Math.pow(2,t)*n;return o=Math.round(o),Math.min(e,o)},t.prototype.setMaxBackoffMs=function(t){this.maxBackoffInMs=t;},t.prototype.backoff=function(e,n){var i=this;if(void 0!==this.timerHandle&&(this.logger.debug("Clearing current back off"),clearTimeout(this.timerHandle),this.timerHandle=void 0),void 0!==this.previousCompleteTime){var r=Date.now()-this.previousCompleteTime;r>this.maxBackoffInMs*this.gapDetectionSettings.tolerance&&r>this.gapDetectionSettings.minimumWaitMs&&(this.logger.info("Back off for ".concat(e," with ID ").concat(this.backoffId," will be reset due to a lot of time having passed since the previous backoff (").concat(r," ms)")),this.backoffCount=0,this.previousCompleteTime=void 0);}var s=t.calculateNextBackoffMs(this.backoffCount,this.maxBackoffInMs);this.backoffId++,this.backoffCount++,this.logger.info("Backing off ".concat(e," for ").concat(s," milliseconds with ID ").concat(this.backoffId)),this.callback=function(t,r){o(t,r,i.gapDetectionSettings)&&(i.logger.info("Back off for ".concat(e," with ID ").concat(i.backoffId," will be reset due to the wait (").concat(Date.now()-(null!==t&&void 0!==t?t:0)," ms) being longer than expected (").concat(r," ms)")),i.backoffCount=0),i.logger.info("Back off for ".concat(e," with ID ").concat(i.backoffId," complete, invoking handler")),i.timerHandle=void 0,i.callback=void 0,i.previousCompleteTime=Date.now(),n();};var c=Date.now();this.timerHandle=setTimeout(function(){var t;return null===(t=i.callback)||void 0===t?void 0:t.call(i,c,s)},s);},t.prototype.reset=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off with ID ".concat(this.backoffId)),clearTimeout(this.timerHandle),this.timerHandle=void 0,this.callback=void 0),this.backoffCount=0;},t.prototype.expediteIfPending=function(){if(this.backoffCount=0,void 0!==this.timerHandle){this.logger.debug("Expediting back off with ID ".concat(this.backoffId)),clearTimeout(this.timerHandle),this.timerHandle=void 0;var t=this.callback;this.callback=void 0,t&&t();}},t}();e.ExponentialBackoff=i;},function(t,e,n){var o=this&&this.__spreadArray||function(t,e,n){if(n||2===arguments.length)for(var o,i=0,r=e.length;i<r;i++)!o&&i in e||(o||(o=Array.prototype.slice.call(e,0,i)),o[i]=e[i]);return t.concat(o||Array.prototype.slice.call(e))};Object.defineProperty(e,"__esModule",{value:!0}),e.LoggingManagerConsumer=e.RegistrationEnforcer=void 0;var i=n(6),r=function(){function t(t,e,n){this.wrapped=t,this.shouldConnectionDependOnRegistration=e,this.shouldHoldBackEvents=n,this.isRegistered=!1,this.heldBackEvents=[];}return t.prototype.onDownstreamRequest=function(t,e,n){this.passIfRegisteredOrNotNeeded("onDownstreamRequest",t,e,n);},t.prototype.onConnected=function(t){this.passIfRegisteredOrNotNeeded("onConnected",t);},t.prototype.onRegistered=function(t){this.isRegistered=!0,this.wrapped.onRegistered(t),this.fireHeldBackEvents();},t.prototype.onUnregistered=function(t){this.isRegistered=!1,this.wrapped.onUnregistered(t),t.getState()===i.State.Connected&&this.shouldConnectionDependOnRegistration()&&t.forceReconnectDueToNoRegistration();},t.prototype.onReconnecting=function(t){this.wrapped.onReconnecting(t);},t.prototype.onReconnectIsRequired=function(t,e,n){this.wrapped.onReconnectIsRequired(t,e,n);},t.prototype.onDisconnected=function(t){this.isRegistered=!1,this.dropHeldBackEvents(),this.wrapped.onDisconnected(t);},t.prototype.onTerminalError=function(t){this.wrapped.onTerminalError(t);},t.prototype.onConnectionParametersUpdated=function(t){this.wrapped.onConnectionParametersUpdated(t);},t.prototype.onTrouterMessageLost=function(t){this.passIfRegisteredOrNotNeeded("onTrouterMessageLost",t);},t.prototype.onUserActivityStateAccepted=function(t){this.passIfRegisteredOrNotNeeded("onUserActivityStateAccepted",t);},t.prototype.onAudiencesSetResolved=function(t,e){this.passIfRegisteredOrNotNeeded("onAudiencesSetResolved",t,e);},t.prototype.getState=function(){return this.wrapped.getState()},t.prototype.holdBackEvent=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.heldBackEvents.push({kind:t,args:e});},t.prototype.passIfRegisteredOrNotNeeded=function(t){for(var e,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];var r=this.shouldConnectionDependOnRegistration(),s=this.shouldHoldBackEvents();r&&s||this.fireHeldBackEvents(r?function(t){return "onConnected"!==t.kind}:void 0),this.isRegistered||!r||!1===s&&"onConnected"!==t?(e=this.wrapped)[t].apply(e,n):this.holdBackEvent.apply(this,o([t],n,!1));},t.prototype.fireHeldBackEvents=function(t){for(var e,n=0,o=this.heldBackEvents;n<o.length;n++){var i=o[n];(void 0===t||t(i))&&(e=this.wrapped)[i.kind].apply(e,i.args);}this.heldBackEvents=void 0===t?[]:this.heldBackEvents.filter(function(e){return !t(e)});},t.prototype.dropHeldBackEvents=function(){this.heldBackEvents=[];},t}();e.RegistrationEnforcer=r;var s=function(){function t(t,e,n,o){this.wrapped=t,this.prefix=e,this.logger=n,this.onEventAction=o;}return t.prototype.onEvent=function(t,e){var n;void 0!==this.onEventAction?this.onEventAction(t,e):(null!==(n=this.logger)&&void 0!==n?n:console).log("".concat(this.prefix," TracingEnforcer: ").concat(t,"(").concat(e,")"));},t.prototype.onDownstreamRequest=function(t,e,n){this.onEvent("onDownstreamRequest",JSON.stringify({request:e,response:n})),this.wrapped.onDownstreamRequest(t,e,n);},t.prototype.onConnected=function(t){this.onEvent("onConnected",t.getState().toString()),this.wrapped.onConnected(t);},t.prototype.onRegistered=function(t){this.onEvent("onRegistered",t.getState().toString()),this.wrapped.onRegistered(t);},t.prototype.onUnregistered=function(t){this.onEvent("onUnregistered",t.getState().toString()),this.wrapped.onUnregistered(t);},t.prototype.onReconnecting=function(t){this.onEvent("onReconnecting",t.getState().toString()),this.wrapped.onReconnecting(t);},t.prototype.onReconnectIsRequired=function(t,e,n){this.onEvent("onReconnectIsRequired",JSON.stringify({connection:t.getState().toString(),useConnectParamsFromCache:e,reason:n})),this.wrapped.onReconnectIsRequired(t,e,n);},t.prototype.onDisconnected=function(t){this.onEvent("onDisconnected",t.getState().toString()),this.wrapped.onDisconnected(t);},t.prototype.onTerminalError=function(t){this.onEvent("onTerminalError",JSON.stringify({connection:t})),this.wrapped.onTerminalError(t);},t.prototype.onConnectionParametersUpdated=function(t){this.onEvent("onConnectionParametersUpdated",JSON.stringify({connectParams:t})),this.wrapped.onConnectionParametersUpdated(t);},t.prototype.onTrouterMessageLost=function(t){this.onEvent("onTrouterMessageLost",JSON.stringify({flowTags:t})),this.wrapped.onTrouterMessageLost(t);},t.prototype.onUserActivityStateAccepted=function(t){this.onEvent("onUserActivityStateAccepted",JSON.stringify({cv:t})),this.wrapped.onUserActivityStateAccepted(t);},t.prototype.onAudiencesSetResolved=function(t,e){this.onEvent("onAudiencesSetResolved",JSON.stringify({audienceSubscriptionsResponse:t,cv:e})),this.wrapped.onAudiencesSetResolved(t,e);},t.prototype.getState=function(){return this.wrapped.getState()},t}();e.LoggingManagerConsumer=s;},function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.TrouterManagerFsm=void 0;var o=n(2),i=n(4),r=n(0),s=n(7),c=function(){function t(t,e){this.worker=e,this.state=i.TrouterManagerState.Unknown,this.logger=new r.Logger("ManagerFsm",t);}return t.prototype.start=function(){this.state===i.TrouterManagerState.Unknown?(this.setState(i.TrouterManagerState.Disconnected),this.worker.forceStopLingeringConnection(),this.worker.startFirstConnection()):(this.logger.info("start called in state '".concat(i.TrouterManagerState[this.state],"', expediting pending backoffs, if any")),this.worker.expediteBackoffOnConnections());},t.prototype.stop=function(t){this.state!==i.TrouterManagerState.Unknown?(this.setState(i.TrouterManagerState.Unknown),this.worker.stopFirstConnection(!0===t),this.worker.stopSecondConnection(!0===t)):this.showIgnored("stop");},t.prototype.getState=function(){switch(this.state){case i.TrouterManagerState.Unknown:case i.TrouterManagerState.Connected:case i.TrouterManagerState.Disconnected:case i.TrouterManagerState.Switching:return this.state;case i.TrouterManagerState.TerminalError:return o.TrouterState.Disconnected}},t.prototype.getInternalState=function(){return this.state},t.prototype.onConnected=function(t){this.state===i.TrouterManagerState.Disconnected&&t?this.worker.doesSecondConnectionExist()?this.setState(i.TrouterManagerState.Switching):(this.setState(i.TrouterManagerState.Connected),this.worker.dispatchConnected()):this.showIgnored("onConnected(".concat(t,")"));},t.prototype.onRegistered=function(t){this.state!==i.TrouterManagerState.Disconnected||t?this.state!==i.TrouterManagerState.Switching||t?this.state===i.TrouterManagerState.Disconnected&&t&&(this.setState(i.TrouterManagerState.Connected),this.worker.dispatchConnected()):(this.setState(i.TrouterManagerState.Connected),this.worker.switchConnections(),this.worker.stopSecondConnectionDelayed(),this.worker.dispatchConnected()):(this.setState(i.TrouterManagerState.Connected),this.worker.switchConnections(),this.worker.stopSecondConnection(!0),this.worker.dispatchConnected()),this.worker.dispatchRegistrationState(!0);},t.prototype.onUnregistered=function(t){t&&this.worker.dispatchRegistrationState(!1);},t.prototype.onReconnecting=function(t){this.state!==i.TrouterManagerState.Connected&&this.state!==i.TrouterManagerState.Switching||!t?this.showIgnored("onReconnecting(".concat(t,")")):(this.setState(i.TrouterManagerState.Disconnected),this.worker.dispatchDisconnected());},t.prototype.onReconnectionRequired=function(t,e,n){this.state===i.TrouterManagerState.Connected&&t?(this.setState(i.TrouterManagerState.Switching),this.worker.startSecondConnection(e)):this.state===i.TrouterManagerState.Disconnected&&t?this.worker.startSecondConnection(e):this.state===i.TrouterManagerState.Switching&&t&&n===s.ReconnectReason.Configuration?(this.logger.debug("onReconnectionRequired: switch requested while already in Switching state"),this.worker.stopSecondConnection(!0),this.worker.startSecondConnection(e)):this.showIgnored("onReconnectionRequired(".concat(t,")"));},t.prototype.onDisconnected=function(t){this.state==i.TrouterManagerState.Unknown&&t?this.worker.dispatchDisconnected():this.state==i.TrouterManagerState.Switching&&t?(this.worker.switchConnections(),this.worker.stopSecondConnection(!1),this.setState(i.TrouterManagerState.Disconnected),this.worker.dispatchDisconnected()):this.showIgnored("onDisconnected(".concat(t,")"));},t.prototype.onTerminalError=function(){this.setState(i.TrouterManagerState.TerminalError),this.worker.dispatchTerminalError();},t.prototype.showIgnored=function(t){this.logger.info("Ignoring event '".concat(t,"' in state '").concat(i.TrouterManagerState[this.state],"'"));},t.prototype.setState=function(t){if(this.logger.info("Switching from state '".concat(i.TrouterManagerState[this.state],"' to state '").concat(i.TrouterManagerState[t],"'")),this.state===t)return void this.logger.error("Attempt to switch to the current state '".concat(i.TrouterManagerState[t],"'"));this.state=t;},t}();e.TrouterManagerFsm=c;},function(t,e,n){function o(t,e){if(!e)return t;var n=h(h({},t),{enabled:e.TelemetryEnabled});return void 0!==e.ClientTelemetryEventEnabled&&(n=h(h({},n),e.ClientTelemetryEventEnabled)),n}function i(t,e,n){var i,r,s,c,a,u,d,l,p,g,f=function(n){return t.proxyUrlRewrite?(e.info("Using rewritten URL for proxy"),t.proxyUrlRewrite(n)):n};return {clientInfo:{ua:t.trouterSettings.productName,v:t.trouterSettings.version},ioOptions:{ackTimeoutMs:5e3,rewriteUrlForProxy:f},clientCorrelationID:t.trouterSettings.sessionId,environment:t.trouterSettings.environment,telemetrySettings:o(t.telemetryConfig.settings,n),eventLogger:t.telemetryConfig.eventLogger,endpointId:t.trouterSettings.registrationId,trouterUrl:(null===n||void 0===n?void 0:n.TrouterConnectionUrl)||t.trouterSettings.trouterServiceUrl,registration:t.trouterSettings.registrarServiceUrl?{registrarUrl:t.trouterSettings.registrarServiceUrl,registrationId:null!==(i=t.trouterSettings.registrationId)&&void 0!==i?i:"",pnhAppId:null!==(r=t.trouterSettings.pnhAppId)&&void 0!==r?r:"",platform:null!==(s=t.trouterSettings.platform)&&void 0!==s?s:"",pnhTemplateKey:null!==(c=t.trouterSettings.pnhTemplate)&&void 0!==c?c:"",platformUIVersion:null!==(a=t.trouterSettings.platformUIVersion)&&void 0!==a?a:"",productContext:t.trouterSettings.pnhProductContext||void 0,context:null!==(u=t.trouterSettings.pnhContext)&&void 0!==u?u:"",registrarTtlSec:(null!==(d=t.trouterSettings.maxRegistrationTimeInMs)&&void 0!==d?d:0)/1e3}:void 0,connectionDependsOnRegistration:void 0===t.trouterSettings.registrarServiceUrl?function(){return !1}:null!==(l=t.trouterSettings.connectionDependsOnRegistration)&&void 0!==l?l:function(){return !1},delayEventsUntilRegistered:null!==(p=t.trouterSettings.delayEventsUntilRegistered)&&void 0!==p?p:function(){return !1},timeoutOptions:h({connectionTimeoutMs:t.trouterSettings.trouterConnectTimeoutInMs||3e4,fetchTimeoutMs:1e4,pingTimeoutMs:4e4,pongTimeoutMs:5e3,maxBackoffMs:"TeamsCDL"===t.trouterSettings.productName?3e5:3e4,requestTimeoutMs:5e3,userActivityResponseTimeoutMs:1e4},t.trouterSettings.timeoutOptions),incallTimeoutOptions:h({connectionTimeoutMs:1e4,fetchTimeoutMs:5e3,pingTimeoutMs:5e3,pongTimeoutMs:2e3,maxBackoffMs:"TeamsCDL"===t.trouterSettings.productName?3e5:1e4,requestTimeoutMs:5e3,userActivityResponseTimeoutMs:1e4},t.trouterSettings.incallTimeoutOptions),incallModeTimeoutMs:null!==(g=t.trouterSettings.incallModeTimeoutMs)&&void 0!==g?g:0,lingeringConnectionDelayMs:6e4,userActivitySecondResendDelayMs:t.trouterSettings.userActivitySecondResendDelayMs||1e4,duplicateDisconnectThresholdMs:1e4,connectionCache:t.connectionCache,registrationStateCallback:t.registrationStateCallbackForAcsDoNotUse,rewriteUrlForProxy:f,retryLimitOnTokenFetch:t.trouterSettings.retryLimitOnTokenFetch,extraConnectionHeaders:t.trouterSettings.extraConnectionHeaders,expediteBackoffOnStartMinimumDelayMs:1e4,toJSON:function(){return h(h({},this),{connectionCache:this.connectionCache?{}:this.connectionCache})}}}function r(t){return new S(t)}function s(){return p.CLIENT_VERSION}function c(t,e){var n=t.indexOf("://");if(n>=0){var o=t.indexOf("/",n+3);if(o>=0)return e+t.substr(o)}return ""}function a(t){var e=this;return function(n){return d(e,void 0,void 0,function(){var e;return l(this,function(o){switch(o.label){case 0:return e={},[4,t(n.needFresh)];case 1:return [2,(e.token=o.sent(),e.tokenType="skype",e)]}})})}}function u(t,e){var n,o=this;return function(i){return d(o,void 0,void 0,function(){var o,r,s;return l(this,function(c){switch(c.label){case 0:o=new Date,r=setInterval(function(){var e=Math.round((Date.now()-o.getTime())/6e4);t.warn("Note: Trouter auth token request promise from ".concat(o.toISOString()," has not been resolved for ").concat(e," minutes. The client is blocked from operating properly"));},3e5),c.label=1;case 1:return c.trys.push([1,,3,4]),[4,e(i)];case 2:return s=c.sent(),i.needFresh&&s.token===n&&t.error("API violation: Trouter auth token provider got a request with needRefresh=true, but returned the same token as last time anyway. Please fix the host app"),n=s.token,[2,s];case 3:return clearInterval(r),[7];case 4:return [2]}})})}}var h=this&&this.__assign||function(){return h=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++){e=arguments[n];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);}return t},h.apply(this,arguments)},d=this&&this.__awaiter||function(t,e,n,o){function i(t){return t instanceof n?t:new n(function(e){e(t);})}return new(n||(n=Promise))(function(n,r){function s(t){try{a(o.next(t));}catch(t){r(t);}}function c(t){try{a(o.throw(t));}catch(t){r(t);}}function a(t){t.done?n(t.value):i(t.value).then(s,c);}a((o=o.apply(t,e||[])).next());})},l=this&&this.__generator||function(t,e){function n(t){return function(e){return o([t,e])}}function o(n){if(i)throw new TypeError("Generator is already executing.");for(;c&&(c=0,n[0]&&(a=0)),a;)try{if(i=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(s=a.trys,!(s=s.length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(6===n[0]&&a.label<s[1]){a.label=s[1],s=n;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(n);break}s[2]&&a.ops.pop(),a.trys.pop();continue}n=e.call(t,a);}catch(t){n=[6,t],r=0;}finally{i=s=0;}if(5&n[0])throw n[1];return {value:n[0]?n[1]:void 0,done:!0}}var i,r,s,c,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return c={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c};Object.defineProperty(e,"__esModule",{value:!0}),e.replaceTrouterUrlBase=e.getTrouterServiceVersion=e.createTrouterService=e.TrouterService=e.UserActivityState=e.TrouterState=void 0;var p=n(1),g=n(2);Object.defineProperty(e,"TrouterState",{enumerable:!0,get:function(){return g.TrouterState}}),Object.defineProperty(e,"UserActivityState",{enumerable:!0,get:function(){return g.UserActivityState}});var f=n(0),v=n(8),m=n(9),y=n(10),T=n(11),S=function(){function t(t){this.logProvider=t,this.stateChangedListeners=[],this.logger=new f.Logger("Trouter",t),this.trouterUrlPromise=new T.TrouterUrlPromise(t),this.messageHandlers=new v.MessageHandlerRegistry(t),this.listeners={},this.connectionInfo=null,this.logger.info("Created TrouterService version ".concat(p.CLIENT_VERSION));}return t.prototype.start=function(t){var e;if(this.logger.info("Start"),!t.skypeTokenProvider&&!t.authTokenProvider)throw new Error("no token provider has been configured, either skypeTokenProvider or authTokenProvider must be populated");t.skypeTokenProvider&&!t.trouterSettings.disableInternalSkypeTokenCache&&(t.skypeTokenProvider=(0, m.addCacheAsBackupTo)(t.skypeTokenProvider)),this.trouterCfg=t;var n=i(t,this.logger,this.ecsCfg);!1===t.internalEnableV4cProtocol&&(n.forceV4aProtocol=!0);var o=u(this.logger,null!==(e=t.authTokenProvider)&&void 0!==e?e:a(t.skypeTokenProvider));void 0===this.trouterServer&&(this.trouterServer=new y.TrouterManager(this.logProvider,n,o,void 0===t.authTokenProvider,this)),void 0!==this.pendingActivityState&&(this.trouterServer.setUserActivityState(this.pendingActivityState[0],this.pendingActivityState[1]),this.pendingActivityState=void 0),this.trouterServer.start();},t.prototype.stop=function(t){this.logger.info("close connection"),this.trouterUrlPromise.rejectUrl(new Error("TrouterService is stopped")),void 0!==this.trouterServer&&this.trouterServer.stop(t);},t.prototype.setEcsConfig=function(t){return d(this,void 0,void 0,function(){var e=this;return l(this,function(n){return [2,new Promise(function(n){if(e.ecsCfg=t.TrouterJScriptClient,e.logger.info("Setting ECS configuration to ".concat(JSON.stringify(e.ecsCfg))),void 0!==e.trouterServer&&void 0!==e.trouterCfg){var o=i(e.trouterCfg,e.logger,e.ecsCfg);e.trouterServer.configure(o);}n();})]})})},t.prototype.checkConnection=function(t){void 0!==this.trouterServer&&this.trouterServer.checkConnection(null!==t&&void 0!==t&&t);},t.prototype.resendRegistration=function(){return d(this,void 0,void 0,function(){return l(this,function(t){if(!this.trouterServer)throw new Error("resendRegistration called too early");return [2,this.trouterServer.resendRegistration()]})})},t.prototype.registerListener=function(t,e){return ""===e||!e.startsWith("/")||e.includes("?")||e.includes("#")?(this.logger.error("Listener path '".concat(e,"' is not valid")),!1):this.listeners[e]?(this.logger.error("Another listener is already registered for path '".concat(e,"'")),!1):(this.listeners[e]=t,this.logger.debug("Listener for path '".concat(e,"' registered")),this.connectionInfo&&t.onTrouterConnected(this.connectionInfo.baseEndpointUrl+e,this.connectionInfo),!0)},t.prototype.unregisterListener=function(t){for(var e=[],n=0,o=Object.keys(this.listeners);n<o.length;n++){var i=o[n];this.listeners[i]===t&&e.push(i);}if(0===e.length)return !1;for(var r=0,s=e;r<s.length;r++){var i=s[r];delete this.listeners[i];}return this.logger.debug("Listener for path(s) '".concat(e.join("', '"),"' unregistered")),!0},t.prototype.onTrouterConnected=function(t,e){this.logger.debug("Trouter is now connected");for(var n=0,o=Object.keys(this.listeners);n<o.length;n++){var i=o[n];try{this.listeners[i].onTrouterConnected(e.baseEndpointUrl+i,e);}catch(t){this.logger.error("Listener '".concat(i,"' threw an exception from onTrouterConnected(): ").concat(t));}}this.connectionInfo=e,this.trouterUrlPromise.resolveUrl(t),this.notifyStateChanged(g.TrouterState.Connected,{url:t,getRemainingTtlInSec:function(){return e.connectionTtlSec}});},t.prototype.onTrouterDisconnected=function(){this.logger.debug("Trouter is now disconnected"),this.connectionInfo=null;for(var t=0,e=Object.keys(this.listeners);t<e.length;t++){var n=e[t],o=this.listeners[n];if(o.onTrouterDisconnected)try{o.onTrouterDisconnected();}catch(t){this.logger.error("Listener '".concat(n,"' threw an exception from onTrouterDisconnected(): ").concat(t));}}this.notifyStateChanged(g.TrouterState.Disconnected);},t.prototype.onTrouterRequest=function(t,e){for(var n="",o=0,i=Object.keys(this.listeners);o<i.length;o++){var r=i[o];t.path.startsWith(r)&&r.length>n.length&&(n=r);}if(""===n)this.tryMessageHandlers(t,e)||(e.status=404,e.headers={"Trouter-Responder":"ClientLib"},e.send());else try{this.listeners[n].onTrouterRequest(t,e);}catch(t){this.logger.error("Listener '".concat(n,"' threw an exception from onTrouterRequest(): ").concat(t)),e.status=500,e.headers={"Trouter-Responder":"ClientLib"},e.send();}},t.prototype.onTrouterMessageLoss=function(t){this.logger.info("onTrouterMessageLoss called with tags [".concat(t,"]"));for(var e=!0,n=0,o=Object.keys(this.listeners);n<o.length;n++){var i=o[n],r=this.listeners[i];if(r.onTrouterMessageLoss)try{e=r.onTrouterMessageLoss(t)&&e,void 0===e&&(this.logger.error("Listener '".concat(i,"' did not return a boolean value from onTrouterMessageLoss()")),e=!1);}catch(t){this.logger.error("Listener '".concat(i,"' threw an exception from onTrouterMessageLoss(): ").concat(t)),e=!1;}}return e},t.prototype.onTrouterUserActivityStateAccepted=function(t){this.logger.debug("onTrouterUserActivityStateAccepted cv: ".concat(t));for(var e=0,n=Object.keys(this.listeners);e<n.length;e++){var o=n[e],i=this.listeners[o];if(i.onTrouterUserActivityStateAccepted)try{i.onTrouterUserActivityStateAccepted(t);}catch(t){this.logger.error("Listener '".concat(o,"' threw an exception from onTrouterUserActivityStateAccepted(): ").concat(t));}}},t.prototype.onAudiencesSetResolved=function(t,e){this.logger.debug("onAudiencesSetResolved cv: ".concat(e));for(var n=0,o=Object.keys(this.listeners);n<o.length;n++){var i=o[n],r=this.listeners[i];if(r.onAudiencesSetResolved)try{r.onAudiencesSetResolved(t,e);}catch(t){this.logger.error("Listener '".concat(i,"' threw an exception from onAudienceSubscribed(): ").concat(t));}}},t.prototype.setUserActivityState=function(t,e){if(t!==g.UserActivityState.Active&&t!==g.UserActivityState.Inactive)throw new Error("setUserActivityState called with unsupported value ".concat(t));this.logger.info("setUserActivityState called with value ".concat(g.UserActivityState[t])),this.trouterServer&&this.state()!==g.TrouterState.Unknown?this.trouterServer.setUserActivityState(t,e):(this.pendingActivityState=[t,e],this.logger.warn("setUserActivityState called before start() or after stop()"));},t.prototype.setAudienceSubscriptions=function(t,e){if(t.audienceSubscriptions.length>1)throw new Error("Only singular audience subscription is supported");if(this.trouterServer&&this.state()!==g.TrouterState.Unknown)return this.trouterServer.setAudienceSubscriptionsAsync(t,15e3,e);throw new Error("audience subscribe called before start() or after stop()")},t.prototype.state=function(){return void 0!==this.trouterServer?this.trouterServer.getState():g.TrouterState.Unknown},t.prototype.isInTerminalState=function(){return void 0!==this.trouterServer&&this.trouterServer.isInTerminalState()},t.prototype.reportStateInfo=function(){return void 0===this.trouterServer?"":this.trouterServer.reportStateInfo()},t.prototype.getServerState=function(){if(void 0!==this.trouterServer)return this.trouterServer.getServerState()},t.prototype.getTrouterUrlAsync=function(){return void 0!==this.trouterServer?this.trouterUrlPromise.getPromise():Promise.reject(new Error("TrouterService has not been started"))},t.prototype.onStateChanged=function(t){if(this.logger.info("onStateChanged called"),void 0===t)this.stateChangedListeners=this.stateChangedListeners.filter(function(t){return void 0===t.wrappedCallback});else {this.offStateChanged(t);var e=function(e,n){t(e,n?n.url:"");};e.wrappedCallback=t,this.stateChangedListeners.push(e);}},t.prototype.offStateChanged=function(t){this.logger.info("offStateChanged called");var e=this.stateChangedListeners.length;return this.stateChangedListeners=this.stateChangedListeners.filter(function(e){return e.wrappedCallback!==t}),e>this.stateChangedListeners.length},t.prototype.addCallback=function(t){this.logger.info("addListener called"),-1===this.stateChangedListeners.indexOf(t,0)&&void 0!==t&&this.stateChangedListeners.push(t);},t.prototype.removeCallback=function(t){this.logger.info("removeListener called");var e=this.stateChangedListeners.indexOf(t,0);return e>-1&&(this.stateChangedListeners.splice(e,1),!0)},t.prototype.registerMessageHandler=function(t){this.logger.info("registerMessageHandler is called"),this.messageHandlers.register(t);},t.prototype.clearMessageHandlers=function(){this.logger.info("clearMessageHandlers is called"),this.messageHandlers.clear();},t.prototype.notifyStateChanged=function(t,e){var n=this;this.logger.info("notifyStateChanged called, will forward to ".concat(this.stateChangedListeners.length," listeners")),this.stateChangedListeners.forEach(function(o){try{o(t,e);}catch(t){n.logger.error("Error in callback ".concat(t));}});},t.prototype.tryMessageHandlers=function(t,e){if(!this.messageHandlers.active())return !1;var n,o=null;try{n=JSON.parse(t.body),o=n&&(n.evt||n.eventId)||null;}catch(t){}var i={eventId:o,url:(this.connectionInfo?this.connectionInfo.baseEndpointUrl:"")+t.path,body:n,rawBody:t.body,headers:t.headers},r=this.messageHandlers.handleMessage(i);return !!r.isHandled&&(e.status=r.resultCode,r.responseHeaders&&(e.headers=r.responseHeaders),r.responseBody&&(e.body=r.responseBody),e.send(),!0)},t}();e.TrouterService=S,e.createTrouterService=r,e.getTrouterServiceVersion=s,e.replaceTrouterUrlBase=c;},function(e,n){e.exports=t;}])});

});

unwrapExports(tstrouter);

var constants = createCommonjsModule(function (module, exports) {
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
Object.defineProperty(exports, "__esModule", { value: true });
exports.PACKAGE_VERSION = exports.CONFIG_API_VERSION = exports.EudbCountries = exports.CloudPrefix = exports.CloudType = exports.MAX_NUMBER_OF_TOKEN_FETCH_RETRIES = void 0;
exports.MAX_NUMBER_OF_TOKEN_FETCH_RETRIES = 3;
// Gov cloud types
var CloudType;
(function (CloudType) {
    CloudType["Public"] = "Public";
    CloudType["GccHigh"] = "GCC High";
    CloudType["Dod"] = "DoD";
})(CloudType || (exports.CloudType = CloudType = {}));
var CloudPrefix;
(function (CloudPrefix) {
    CloudPrefix["OrgId"] = "orgid";
    CloudPrefix["Acs"] = "acs";
    CloudPrefix["Spool"] = "spool";
    CloudPrefix["GccHigh"] = "gcch";
    CloudPrefix["GccHighAcs"] = "gcch-acs";
    CloudPrefix["Dod"] = "dod";
    CloudPrefix["DodAcs"] = "dod-acs";
})(CloudPrefix || (exports.CloudPrefix = CloudPrefix = {}));
exports.EudbCountries = ["europe", "france", "germany", "norway", "switzerland", "sweden"];
exports.CONFIG_API_VERSION = "2024-09-01";
exports.PACKAGE_VERSION = "1.0.0-beta.30";
});

unwrapExports(constants);
constants.PACKAGE_VERSION;
constants.CONFIG_API_VERSION;
constants.EudbCountries;
constants.CloudPrefix;
constants.CloudType;
constants.MAX_NUMBER_OF_TOKEN_FETCH_RETRIES;

var constants_1 = constants;

var TrouterUtils = createCommonjsModule(function (module, exports) {
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
var __awaiter = (commonjsGlobal && commonjsGlobal.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.isEudbLocation = exports.parseTokenCredential = exports.base64decode = exports.toTelemetrySender = exports.toLogProvider = exports.toMessageHandler = void 0;
exports.generateUuid = generateUuid;



const eventIds = new Map([
    ["chatMessageReceived", 200],
    ["typingIndicatorReceived", 245],
    ["readReceiptReceived", 246],
    ["chatMessageEdited", 247],
    ["chatMessageDeleted", 248],
    ["streamingChatMessageStarted", 250],
    ["streamingChatMessageChunkReceived", 251],
    ["chatThreadCreated", 257],
    ["chatThreadPropertiesUpdated", 258],
    ["chatThreadDeleted", 259],
    ["participantsAdded", 260],
    ["participantsRemoved", 261],
]);
const publicTeamsUserPrefix = "8:orgid:";
const dodTeamsUserPrefix = "8:dod:";
const gcchTeamsUserPrefix = "8:gcch:";
const teamsVisitorUserPrefix = "8:teamsvisitor:";
const phoneNumberPrefix = "4:";
const acsUserPrefix = "8:acs:";
const acsGcchUserPrefix = "8:gcch-acs:";
const acsDodUserPrefix = "8:dod-acs:";
const spoolUserPrefix = "8:spool:";
const toMessageHandler = (event, listener, resourceEndpoint, gatewayApiVersion) => {
    const eventId = eventIds.get(event);
    return {
        handleMessage(message) {
            let genericPayload = null;
            if (message === null || message === void 0 ? void 0 : message.rawBody) {
                genericPayload = JSON.parse(message.rawBody);
            }
            if (genericPayload === null || genericPayload.eventId !== eventId) {
                return undefined;
            }
            const eventPayload = toEventPayload(event, genericPayload, resourceEndpoint, gatewayApiVersion);
            if (eventPayload === null) {
                return undefined;
            }
            listener(eventPayload);
            return { isHandled: true, resultCode: 200 };
        },
    };
};
exports.toMessageHandler = toMessageHandler;
function toChatMessageReceivedEvent(payload, resourceEndpoint, gatewayApiVersion) {
    let parsedStreamingPayload = parseJsonString(payload.streaming);
    return {
        threadId: payload.groupId,
        sender: constructIdentifierKindFromMri(payload.senderId),
        senderDisplayName: payload.senderDisplayName,
        recipient: constructIdentifierKindFromMri(payload.recipientMri),
        id: payload.messageId,
        createdOn: new Date(payload.originalArrivalTime),
        version: payload.version,
        type: payload.messageType,
        message: payload.messageBody,
        metadata: parseJsonString(payload.acsChatMessageMetadata) || {},
        attachments: transformEndpoint(parseJsonString(payload.attachments) || [], resourceEndpoint, gatewayApiVersion),
        streamingMetadata: {
            streamingMessageType: parsedStreamingPayload === null || parsedStreamingPayload === void 0 ? void 0 : parsedStreamingPayload.contentType,
            streamEndReason: parsedStreamingPayload === null || parsedStreamingPayload === void 0 ? void 0 : parsedStreamingPayload.streamEndReason,
            streamingSequenceNumber: Number(parsedStreamingPayload === null || parsedStreamingPayload === void 0 ? void 0 : parsedStreamingPayload.sequenceNumber),
        }
    };
}
function toChatMessageEditedEvent(payload, resourceEndpoint, gatewayApiVersion) {
    return Object.assign(Object.assign({}, toChatMessageReceivedEvent(payload, resourceEndpoint, gatewayApiVersion)), { editedOn: new Date(payload.edittime), policyViolation: toPolicyViolation(parseJsonString(payload.policyViolation)) });
}
const toEventPayload = (event, genericPayload, resourceEndpoint, gatewayApiVersion) => {
    if (event === "chatMessageReceived") {
        const payload = genericPayload;
        return toChatMessageReceivedEvent(payload, resourceEndpoint, gatewayApiVersion);
    }
    if (event == "streamingChatMessageStarted") {
        const payload = genericPayload;
        return toChatMessageReceivedEvent(payload, resourceEndpoint, gatewayApiVersion);
    }
    if (event == "streamingChatMessageChunkReceived") {
        const payload = genericPayload;
        return toChatMessageEditedEvent(payload, resourceEndpoint, gatewayApiVersion);
    }
    if (event === "chatMessageEdited") {
        const payload = genericPayload;
        return toChatMessageEditedEvent(payload, resourceEndpoint, gatewayApiVersion);
    }
    if (event === "chatMessageDeleted") {
        const payload = genericPayload;
        const eventPayload = {
            threadId: payload.groupId,
            sender: constructIdentifierKindFromMri(payload.senderId),
            senderDisplayName: payload.senderDisplayName,
            recipient: constructIdentifierKindFromMri(payload.recipientMri),
            id: payload.messageId,
            createdOn: new Date(payload.originalArrivalTime),
            version: payload.version,
            deletedOn: new Date(payload.deletetime),
            type: payload.messageType,
        };
        return eventPayload;
    }
    if (event === "typingIndicatorReceived") {
        const payload = genericPayload;
        const eventPayload = {
            threadId: payload.groupId,
            sender: constructIdentifierKindFromMri(payload.senderId),
            senderDisplayName: payload.senderDisplayName,
            recipient: constructIdentifierKindFromMri(payload.recipientMri),
            version: payload.version,
            receivedOn: new Date(payload.originalArrivalTime),
        };
        return eventPayload;
    }
    if (event === "readReceiptReceived") {
        const payload = genericPayload;
        const readReceiptMessageBody = JSON.parse(payload.messageBody);
        const consumptionHorizon = readReceiptMessageBody.consumptionhorizon.split(";");
        const eventPayload = {
            threadId: payload.groupId,
            sender: constructIdentifierKindFromMri(payload.senderId),
            senderDisplayName: "",
            recipient: constructIdentifierKindFromMri(payload.recipientMri),
            chatMessageId: payload.messageId,
            readOn: new Date(+consumptionHorizon[1]),
        };
        return eventPayload;
    }
    if (event === "chatThreadCreated") {
        const payload = genericPayload;
        const createdByPayload = JSON.parse(unescape(payload.createdBy));
        const membersPayload = JSON.parse(unescape(payload.members));
        const createdBy = toChatParticipant(createdByPayload);
        const chatParticipants = membersPayload.map((m) => {
            return toChatParticipant(m);
        });
        const eventPayload = {
            threadId: payload.threadId,
            createdOn: new Date(payload.createTime),
            createdBy: createdBy,
            version: payload.version,
            participants: chatParticipants,
            properties: toThreadProperties(JSON.parse(unescape(payload.properties))),
        };
        return eventPayload;
    }
    if (event === "chatThreadPropertiesUpdated") {
        const payload = genericPayload;
        const updatedByPayload = JSON.parse(unescape(payload.editedBy));
        const updatedBy = toChatParticipant(updatedByPayload);
        const eventPayload = {
            threadId: payload.threadId,
            updatedOn: new Date(payload.editTime),
            updatedBy: updatedBy,
            version: payload.version,
            properties: toThreadProperties(JSON.parse(unescape(payload.properties))),
        };
        return eventPayload;
    }
    if (event === "chatThreadDeleted") {
        const payload = genericPayload;
        const deletedBy = toChatParticipant(JSON.parse(unescape(payload.deletedBy)));
        const eventPayload = {
            threadId: payload.threadId,
            deletedOn: new Date(payload.deleteTime),
            deletedBy: deletedBy,
            version: payload.version,
        };
        return eventPayload;
    }
    if (event === "participantsAdded") {
        const payload = genericPayload;
        const addedByPayload = JSON.parse(unescape(payload.addedBy));
        const participantsAddedPayload = JSON.parse(unescape(payload.participantsAdded));
        const addedBy = toChatParticipant(addedByPayload);
        const chatParticipants = participantsAddedPayload.map((m) => {
            return toChatParticipant(m);
        });
        const eventPayload = {
            threadId: payload.threadId,
            addedOn: new Date(payload.time),
            addedBy: addedBy,
            version: payload.version,
            participantsAdded: chatParticipants,
        };
        return eventPayload;
    }
    if (event === "participantsRemoved") {
        const payload = genericPayload;
        const removedByPayload = JSON.parse(unescape(payload.removedBy));
        const participantsRemovedPayload = JSON.parse(unescape(payload.participantsRemoved));
        const removedBy = toChatParticipant(removedByPayload);
        const chatParticipants = participantsRemovedPayload.map((m) => {
            return toChatParticipant(m);
        });
        const eventPayload = {
            threadId: payload.threadId,
            removedOn: new Date(payload.time),
            removedBy: removedBy,
            version: payload.version,
            participantsRemoved: chatParticipants,
        };
        return eventPayload;
    }
    return null;
};
const toChatParticipant = (payload) => {
    var _a;
    const participant = {
        id: constructIdentifierKindFromMri(payload.participantId),
        displayName: payload.displayName,
        metadata: parseJsonString((_a = payload.memberMetaData) !== null && _a !== void 0 ? _a : "") || {},
    };
    if (payload.shareHistoryTime) {
        participant.shareHistoryTime = new Date(payload.shareHistoryTime);
    }
    return participant;
};
const toThreadProperties = (payload) => {
    var _a;
    return {
        topic: payload.topic,
        metadata: parseJsonString((_a = payload.acsChatThreadMetadata) !== null && _a !== void 0 ? _a : "") || {},
    };
};
const toPolicyViolation = (payload) => {
    if (!payload || (payload === null || payload === void 0 ? void 0 : payload.result) === undefined) {
        return undefined;
    }
    return {
        result: payload.result,
    };
};
const toLogProvider = (logger) => {
    return {
        log: (...message) => logger.info(message),
        warn: (...message) => logger.warning(message),
        error: (...message) => logger.error(message),
        debug: (...message) => logger.verbose(message),
        info: (...message) => logger.verbose(message),
    };
};
exports.toLogProvider = toLogProvider;
const toTelemetrySender = (logger) => {
    return {
        logEvent: (clientEvent) => logger.info(clientEvent),
    };
};
exports.toTelemetrySender = toTelemetrySender;
const constructIdentifierKindFromMri = (mri) => {
    if (mri.startsWith(publicTeamsUserPrefix)) {
        return {
            kind: "microsoftTeamsUser",
            rawId: mri,
            microsoftTeamsUserId: mri.substring(publicTeamsUserPrefix.length),
            isAnonymous: false,
            cloud: "public",
        };
    }
    else if (mri.startsWith(dodTeamsUserPrefix)) {
        return {
            kind: "microsoftTeamsUser",
            rawId: mri,
            microsoftTeamsUserId: mri.substring(dodTeamsUserPrefix.length),
            isAnonymous: false,
            cloud: "dod",
        };
    }
    else if (mri.startsWith(gcchTeamsUserPrefix)) {
        return {
            kind: "microsoftTeamsUser",
            rawId: mri,
            microsoftTeamsUserId: mri.substring(gcchTeamsUserPrefix.length),
            isAnonymous: false,
            cloud: "gcch",
        };
    }
    else if (mri.startsWith(teamsVisitorUserPrefix)) {
        return {
            kind: "microsoftTeamsUser",
            rawId: mri,
            microsoftTeamsUserId: mri.substring(teamsVisitorUserPrefix.length),
            isAnonymous: true,
        };
    }
    else if (mri.startsWith(phoneNumberPrefix)) {
        return {
            kind: "phoneNumber",
            rawId: mri,
            phoneNumber: mri.substring(phoneNumberPrefix.length),
        };
    }
    else if (mri.startsWith(acsUserPrefix) ||
        mri.startsWith(acsGcchUserPrefix) ||
        mri.startsWith(acsDodUserPrefix) ||
        mri.startsWith(spoolUserPrefix)) {
        return { kind: "communicationUser", communicationUserId: mri };
    }
    else {
        return { kind: "unknown", id: mri };
    }
};
const parseJsonString = (str) => {
    if (str === undefined ||
        str === null ||
        str === "" ||
        str === "null" ||
        str === "{}" ||
        str === "[]") {
        return undefined;
    }
    return JSON.parse(str);
};
const createMediaUrlString = (urlString, resourceEndpoint, gatewayApiVersion) => {
    let url;
    try {
        url = new URL(urlString);
        if (url.protocol === "http:" || url.protocol === "https:") {
            // If its already a full url, substitute the origin
            url = new URL(url.pathname, resourceEndpoint);
        }
    }
    catch (_) {
        // urlString is a likely a relative URL, so create a new one with the resourceEndpoint as base
        try {
            url = new URL(urlString, resourceEndpoint);
        }
        catch (_) {
            // If we get here, then the urlString passed in is likely incorrect, so just pass it along
            // As there's nothing we can do at this point.
            return urlString;
        }
    }
    // Append api-version query and return string
    url.searchParams.set("api-version", gatewayApiVersion);
    return url.toString();
};
const isValidURL = (str) => {
    let url;
    try {
        url = new URL(str);
    }
    catch (_) {
        return false;
    }
    return url.protocol === "http:" || url.protocol === "https:";
};
const transformEndpoint = (attachments, resourceEndpoint, gatewayApiVersion) => {
    if (resourceEndpoint === undefined ||
        resourceEndpoint === null ||
        resourceEndpoint === "" ||
        !isValidURL(resourceEndpoint)) {
        return attachments;
    }
    attachments
        .filter((e) => e.attachmentType.toLowerCase() === "image".toLowerCase())
        .map((attachment) => {
        if (attachment.previewUrl) {
            attachment.previewUrl = createMediaUrlString(attachment.previewUrl, resourceEndpoint, gatewayApiVersion);
        }
        if (attachment.url) {
            attachment.url = createMediaUrlString(attachment.url, resourceEndpoint, gatewayApiVersion);
        }
    });
    return attachments;
};
const base64decode = (encodedString) => !coreUtil__default["default"].isNodeLike ? atob(encodedString) : Buffer.from(encodedString, "base64").toString();
exports.base64decode = base64decode;
const parseJWT = (token) => {
    let [, payload] = token === null || token === void 0 ? void 0 : token.split(".");
    if (payload === undefined) {
        throw new Error("Invalid token");
    }
    payload = payload.replace(/-/g, "+").replace(/_/g, "/");
    return JSON.parse(decodeURIComponent(escape((0, exports.base64decode)(payload))));
};
const parseTokenCredential = (credential) => __awaiter(void 0, void 0, void 0, function* () {
    const accessToken = yield credential.getToken();
    const jwtToken = accessToken === null || accessToken === void 0 ? void 0 : accessToken.token;
    const parsedJwtToken = parseJWT(jwtToken);
    const identityMri = parsedJwtToken.skypeid;
    const acsResourceId = parsedJwtToken.resourceId;
    const cloudType = getCloudTypeFromSkypeId(identityMri);
    const resourceLocation = parsedJwtToken.resourceLocation || "";
    return { jwtToken, acsResourceId, identityMri, cloudType, resourceLocation };
});
exports.parseTokenCredential = parseTokenCredential;
/**
 * Generated Universally Unique Identifier
 *
 * @returns RFC4122 v4 UUID.
 * @internal
 */
function generateUuid() {
    return (0, uuid__default["default"].v4)();
}
const isEudbLocation = (location) => !!location && !!constants_1.EudbCountries.find((euLocation) => euLocation === location);
exports.isEudbLocation = isEudbLocation;
function getCloudTypeFromSkypeId(skypeId) {
    const cloudPrefix = skypeId.substring(0, skypeId.indexOf(":"));
    switch (cloudPrefix) {
        case constants_1.CloudPrefix.OrgId:
        case constants_1.CloudPrefix.Acs:
        case constants_1.CloudPrefix.Spool: {
            return constants_1.CloudType.Public;
        }
        case constants_1.CloudPrefix.GccHigh:
        case constants_1.CloudPrefix.GccHighAcs: {
            return constants_1.CloudType.GccHigh;
        }
        case constants_1.CloudPrefix.Dod:
        case constants_1.CloudPrefix.DodAcs: {
            return constants_1.CloudType.Dod;
        }
        default: {
            return constants_1.CloudType.Public;
        }
    }
}
});

unwrapExports(TrouterUtils);
TrouterUtils.isEudbLocation;
TrouterUtils.parseTokenCredential;
TrouterUtils.base64decode;
TrouterUtils.toTelemetrySender;
TrouterUtils.toLogProvider;
TrouterUtils.toMessageHandler;
TrouterUtils.generateUuid;

var TrouterConfigClient_1$1 = createCommonjsModule(function (module, exports) {
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
var __createBinding = (commonjsGlobal && commonjsGlobal.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (commonjsGlobal && commonjsGlobal.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (commonjsGlobal && commonjsGlobal.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (commonjsGlobal && commonjsGlobal.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RealTimeNotificationConfiguration = exports.TrouterConfigClient = void 0;
const coreClient = __importStar(coreClient__default["default"]); // External library import
 // Grouped imports from the same module

class TrouterConfigClient extends coreClient.ServiceClient {
    constructor(endpoint, options) {
        // Initializing default values for options
        if (!options) {
            options = {};
        }
        const packageDetails = `azsdk-js-communication-signaling/${constants_1.PACKAGE_VERSION}`;
        const userAgentPrefix = options.userAgentOptions && options.userAgentOptions.userAgentPrefix
            ? `${options.userAgentOptions.userAgentPrefix} ${packageDetails}`
            : `${packageDetails}`;
        const clientOptions = Object.assign(Object.assign({}, options), { userAgentOptions: {
                userAgentPrefix,
            }, additionalPolicies: options.additionalPolicies });
        super(clientOptions);
        this.apiVersion = constants_1.CONFIG_API_VERSION;
        this.endpoint = endpoint;
        this.httpClient = (0, coreRestPipeline__default["default"].createDefaultHttpClient)();
    }
    fetchServiceUrls(credential) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const token = (yield credential.getToken()).token;
                const request = (0, coreRestPipeline__default["default"].createPipelineRequest)({
                    url: `${this.endpoint}/chat/config/realTimeNotifications?api-version=${this.apiVersion}`,
                    method: "GET",
                    headers: (0, coreRestPipeline__default["default"].createHttpHeaders)({
                        Authorization: `Bearer ${token}`,
                    }),
                });
                const response = yield this.pipeline.sendRequest(this.httpClient, request);
                if (response.status !== 200 || !response.bodyAsText) {
                    throw new Error(`Failed to fetch service URLs. Status: ${response.status}, Body: ${response.bodyAsText || "No response body"}`);
                }
                const data = JSON.parse(response.bodyAsText);
                // Ensure all necessary data fields are present
                if (!data.trouterServiceUrl || !data.registrarServiceUrl || !data.cloudType) {
                    throw new Error("One or more required fields are missing in the response data");
                }
                return new RealTimeNotificationConfiguration(data.trouterServiceUrl, data.registrarServiceUrl, data.cloudType);
            }
            catch (error) {
                throw new Error(`Error fetching real-time notification configuration from Chat Gateway: ${error.message}`);
            }
        });
    }
}
exports.TrouterConfigClient = TrouterConfigClient;
class RealTimeNotificationConfiguration {
    constructor(trouterServiceUrl, registrarServiceUrl, cloudType) {
        this.trouterServiceUrl = trouterServiceUrl;
        this.registrarServiceUrl = registrarServiceUrl;
        this.cloudType = cloudType;
    }
}
exports.RealTimeNotificationConfiguration = RealTimeNotificationConfiguration;
});

unwrapExports(TrouterConfigClient_1$1);
TrouterConfigClient_1$1.RealTimeNotificationConfiguration;
TrouterConfigClient_1$1.TrouterConfigClient;

var TrouterUtils_1 = TrouterUtils;

var TrouterConfigClient_1 = TrouterConfigClient_1$1;

var TrouterSettings = createCommonjsModule(function (module, exports) {
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
var __awaiter = (commonjsGlobal && commonjsGlobal.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.defaultTelemetrySettings = exports.createSettings = void 0;


const defaultSettings = {
    version: "1.0.0", // SignalingClient version, required for trouter connection
    registrationId: "", // Required for trouter connection
    sessionId: "", // Required for trouter connection
    pnhAppId: "AcsWeb",
    pnhTemplate: "AcsWeb_Chat_2.0",
    platform: "SPOOL",
    platformUIVersion: "0.0.0",
    environment: "", // TBD
    productName: "acs-chat-web",
    trouterServiceUrl: "",
    registrarServiceUrl: "",
    registrarRefreshTimeoutInMs: 350000,
    timeoutOptions: {
        connectionTimeoutMs: 20000,
        fetchTimeoutMs: 10000,
        pingTimeoutMs: 40000,
        pongTimeoutMs: 5000,
        maxBackoffMs: 50000,
        requestTimeoutMs: 5000,
    },
    maxRegistrationTimeInMs: 7200000,
};
// Main function to create settings based on environment
const createSettings = (credential, options) => __awaiter(void 0, void 0, void 0, function* () {
    var _a;
    const endpoint = options === null || options === void 0 ? void 0 : options.resourceEndpoint;
    // Throw an error if resourceEndpoint is null or undefined
    if (endpoint === undefined) {
        throw new Error("'endpoint' cannot be null");
    }
    // Initialize the settings by cloning the default ones
    const settings = Object.assign({}, defaultSettings);
    settings.registrationId = (0, TrouterUtils_1.generateUuid)(); // Generate unique IDs
    settings.sessionId = (0, TrouterUtils_1.generateUuid)();
    // Fetch the real time configuration from the service
    const trouterConfigClient = new TrouterConfigClient_1.TrouterConfigClient(endpoint, options);
    const realTimeNotificationConfiguration = yield trouterConfigClient.fetchServiceUrls(credential);
    // Append suffix to trouterServiceUrl and registrarServiceUrl
    settings.trouterServiceUrl = `${realTimeNotificationConfiguration.trouterServiceUrl}/v4/a`;
    settings.registrarServiceUrl = `${realTimeNotificationConfiguration.registrarServiceUrl}/v3/registrations`;
    // Customize settings if the environment is INT
    if (realTimeNotificationConfiguration.cloudType === "int") {
        settings.pnhAppId = "cns-e2e-test";
        settings.pnhTemplate = "cns-e2e-test:2.0";
    }
    settings.maxRegistrationTimeInMs =
        (_a = options === null || options === void 0 ? void 0 : options.registrationTimeInMs) !== null && _a !== void 0 ? _a : defaultSettings.maxRegistrationTimeInMs;
    return settings;
});
exports.createSettings = createSettings;
exports.defaultTelemetrySettings = {
    // TBD Can we hook up OpenTelemetry?
    enabled: false,
};
});

unwrapExports(TrouterSettings);
TrouterSettings.defaultTelemetrySettings;
TrouterSettings.createSettings;

var TrouterSettings_1 = TrouterSettings;

var SignalingClient = createCommonjsModule(function (module, exports) {
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
var __awaiter = (commonjsGlobal && commonjsGlobal.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CommunicationSignalingClient = void 0;




class CommunicationSignalingClient {
    constructor(credential, logger, options) {
        this.credential = credential;
        this.logger = logger;
        this.options = options;
        this.stateChangedListener = null;
        this.tokenFetchRetries = 0;
        this.trouter = (0, tstrouter.createTrouterService)((0, TrouterUtils_1.toLogProvider)(logger));
    }
    start() {
        return __awaiter(this, void 0, void 0, function* () {
            var _a, _b;
            this.resourceEndpoint = (_a = this.options) === null || _a === void 0 ? void 0 : _a.resourceEndpoint;
            if (this.resourceEndpoint === undefined) {
                throw new Error("'endpoint' cannot be null");
            }
            this.gatewayApiVersion = ((_b = this.options) === null || _b === void 0 ? void 0 : _b.gatewayApiVersion) || "2024-03-07";
            if (this.config === undefined) {
                this.config = {
                    trouterSettings: yield (0, TrouterSettings_1.createSettings)(this.credential, this.options),
                    skypeTokenProvider: (forceRefresh) => __awaiter(this, void 0, void 0, function* () {
                        if (forceRefresh) {
                            this.tokenFetchRetries += 1;
                            if (this.tokenFetchRetries > constants_1.MAX_NUMBER_OF_TOKEN_FETCH_RETRIES) {
                                yield this.stop(true);
                                throw new Error(`Access token is expired and failed to fetch a valid one after ${constants_1.MAX_NUMBER_OF_TOKEN_FETCH_RETRIES} retries`);
                            }
                        }
                        else {
                            this.tokenFetchRetries = 0;
                        }
                        return Promise.resolve((yield this.credential.getToken()).token);
                    }),
                    telemetryConfig: {
                        eventLogger: (0, TrouterUtils_1.toTelemetrySender)(this.logger),
                        settings: TrouterSettings_1.defaultTelemetrySettings,
                    },
                };
            }
            this.trouter.start(this.config);
            this.trouter.setUserActivityState(tstrouter.UserActivityState.Active);
        });
    }
    stop(isTokenExpired) {
        return __awaiter(this, void 0, void 0, function* () {
            this.trouter.offStateChanged(this.stateChangedListener);
            this.trouter.clearMessageHandlers();
            this.trouter.stop(isTokenExpired !== null && isTokenExpired !== void 0 ? isTokenExpired : this.tokenFetchRetries > constants_1.MAX_NUMBER_OF_TOKEN_FETCH_RETRIES);
        });
    }
    on(event, listener) {
        if (event === "connectionChanged") {
            this.trouter.offStateChanged(this.stateChangedListener);
            this.stateChangedListener = (state, _url) => listener(state);
            this.trouter.onStateChanged(this.stateChangedListener);
            return;
        }
        this.trouter.registerMessageHandler((0, TrouterUtils_1.toMessageHandler)(event, listener, this.resourceEndpoint, this.gatewayApiVersion));
    }
    ;
}
exports.CommunicationSignalingClient = CommunicationSignalingClient;
});

unwrapExports(SignalingClient);
SignalingClient.CommunicationSignalingClient;

var require$$0 = SignalingClient;

var src = createCommonjsModule(function (module, exports) {
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
var __createBinding = (commonjsGlobal && commonjsGlobal.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __exportStar = (commonjsGlobal && commonjsGlobal.__exportStar) || function(m, exports) {
    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
};
Object.defineProperty(exports, "__esModule", { value: true });
__exportStar(require$$0, exports);
});

var index = unwrapExports(src);

module.exports = index;
//# sourceMappingURL=index.js.map
